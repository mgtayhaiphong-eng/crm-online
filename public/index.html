<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Sales MG - Gemini AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .drag-over { background-color: #e0e7ff !important; border: 2px dashed #6366f1 !important; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .calendar-day { min-height: 100px; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        @keyframes fade-in-right { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .animate-fade-in-right { animation: fade-in-right 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50">

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBtXRbpGnqTCO7lbtCk2jUQ33VHRT3N5E8",
          authDomain: "crm-mg-1819.firebaseapp.com",
          projectId: "crm-mg-1819",
          storageBucket: "crm-mg-1819.appspot.com",
          messagingSenderId: "1015548726817",
          appId: "1:1015548726817:web:71575fab36551682559d60"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase Connected!");
    </script>

    <div id="root"></div>

    <script type="text/babel">
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error('L·ªói ·ª©ng d·ª•ng:', error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return React.createElement('div', { className: "min-h-screen bg-gray-50 flex items-center justify-center p-8" }, 
                        React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-lg max-w-md text-center" }, [
                            React.createElement('span', { key: 'icon', className: "text-4xl mb-4 block" }, '‚ö†Ô∏è'),
                            React.createElement('h2', { key: 'title', className: "text-xl font-bold text-gray-800 mb-2" }, "ƒê√£ x·∫£y ra l·ªói"),
                            React.createElement('p', { key: 'message', className: "text-gray-600 mb-4" }, "·ª®ng d·ª•ng g·∫∑p s·ª± c·ªë. Vui l√≤ng t·∫£i l·∫°i trang ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi m·∫°ng."),
                            React.createElement('button', { key: 'reload-button', onClick: () => window.location.reload(), className: "px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" }, "T·∫£i l·∫°i trang")
                        ])
                    );
                }
                return this.props.children;
            }
        }

        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const Briefcase = (props) => React.createElement('span', props, 'üíº');
        const List = (props) => React.createElement('span', props, 'üìã');
        const KanbanSquare = (props) => React.createElement('span', props, 'üìä');
        const Phone = (props) => React.createElement('span', props, 'üìû');
        const Mail = (props) => React.createElement('span', props, '‚úâÔ∏è');
        const MapPin = (props) => React.createElement('span', props, 'üìç');
        const DollarSign = (props) => React.createElement('span', props, 'üíµ');
        const X = (props) => React.createElement('span', props, '‚ùå');
        const Plus = (props) => React.createElement('span', props, '‚ûï');
        const Clock = (props) => React.createElement('span', props, '‚è∞');
        const TrendingUp = (props) => React.createElement('span', props, 'üìà');
        const RefreshCw = (props) => React.createElement('span', props, 'üîÑ');
        const Layers = (props) => React.createElement('span', props, 'üìö');
        const SettingsIcon = (props) => React.createElement('span', props, '‚öôÔ∏è');
        const Trash2 = (props) => React.createElement('span', props, 'üóëÔ∏è');
        const Car = (props) => React.createElement('span', props, 'üöó');
        const Users = (props) => React.createElement('span', props, 'üë•');
        const Save = (props) => React.createElement('span', props, 'üíæ');
        const AlertTriangle = (props) => React.createElement('span', props, '‚ö†Ô∏è');
        const BarChartIcon = (props) => React.createElement('span', props, 'üìä');
        const Database = (props) => React.createElement('span', props, 'üíæ');
        const Target = (props) => React.createElement('span', props, 'üéØ');
        
        const VIETNAM_CITIES = [ 'H√† N·ªôi', 'TP H·ªì Ch√≠ Minh', 'ƒê√† N·∫µng', 'H·∫£i Ph√≤ng', 'C·∫ßn Th∆°', 'An Giang', 'B√† R·ªãa - V≈©ng T√†u', 'B·∫Øc Giang', 'B·∫Øc K·∫°n', 'B·∫°c Li√™u', 'B·∫Øc Ninh', 'B·∫øn Tre', 'B√¨nh ƒê·ªãnh', 'B√¨nh D∆∞∆°ng', 'B√¨nh Ph∆∞·ªõc', 'B√¨nh Thu·∫≠n', 'C√† Mau', 'Cao B·∫±ng', 'ƒê·∫Øk L·∫Øk', 'ƒê·∫Øk N√¥ng' ];
        const CUSTOMER_TIERS = [
            { value: 'HOT', label: 'HOT - Ti·ªÅm nƒÉng Cao', color: 'text-red-600', reminderDays: 3 },
            { value: 'WARM', label: 'WARM - ƒêang ChƒÉm s√≥c', color: 'text-yellow-600', reminderDays: 5 },
            { value: 'COLD', label: 'COLD - Kh√°ch h√†ng M·ªõi', color: 'text-indigo-600', reminderDays: 7 },
            { value: 'LOST', label: 'LOST - ƒê√£ Lostsale/Th·∫•t b·∫°i', color: 'text-gray-600', reminderDays: 0 },
        ];

        const formatCurrency = (amount) => { const num = Number(amount); if (isNaN(num) || num === 0) return '0 VNƒê'; return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num); };
        const formatDate = (timestamp) => { if (!timestamp) return '---'; const date = new Date(timestamp); if (isNaN(date)) return '---'; return date.toLocaleDateString('vi-VN'); };
        const formatDateTime = (timestamp) => { if (!timestamp) return '---'; const date = new Date(timestamp); if (isNaN(date)) return '---'; return date.toLocaleString('vi-VN'); };

        const StorageService = {
            getAllData: async function() {
                try {
                    const docRef = db.collection('data').doc('crmData');
                    const docSnap = await docRef.get();
                    if (docSnap.exists) { return docSnap.data(); } 
                    else { return null; }
                } catch (error) {
                    console.error("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:", error);
                    return null;
                }
            },
            saveAllData: async function(data) {
                try {
                    const docRef = db.collection('data').doc('crmData');
                    await docRef.set(data);
                    return true;
                } catch (error) {
                    console.error("L·ªói khi l∆∞u d·ªØ li·ªáu l√™n Firebase:", error);
                    return false;
                }
            },
            resetData: async function() {
                if (confirm('B·∫†N C√ì CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU TR√äN FIREBASE?')) {
                    try {
                        await db.collection('data').doc('crmData').delete();
                        alert('ƒê√£ x√≥a d·ªØ li·ªáu. Vui l√≤ng t·∫£i l·∫°i trang.');
                        window.location.reload();
                        return true;
                    } catch (error) {
                        alert('X√≥a d·ªØ li·ªáu th·∫•t b·∫°i.');
                        return false;
                    }
                }
                return false;
            }
        };
        
        // T√çCH H·ª¢P GEMINI API: D·ªãch v·ª• g·ªçi API
        const GeminiService = {
            generateContent: async function(prompt) {
                const apiKey = ""; // API key ƒë∆∞·ª£c cung c·∫•p b·ªüi m√¥i tr∆∞·ªùng
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                
                let response;
                let delay = 1000;
                for (let i = 0; i < 4; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const candidate = result.candidates?.[0];
                            if (candidate && candidate.content?.parts?.[0]?.text) {
                                return candidate.content.parts[0].text;
                            } else {
                                throw new Error("Ph·∫£n h·ªìi t·ª´ AI kh√¥ng h·ª£p l·ªá.");
                            }
                        }
                        
                        if (response.status >= 500) { // L·ªói server, th·ª≠ l·∫°i
                            console.warn(`L·ªói server API Gemini (${response.status}). Th·ª≠ l·∫°i sau ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else { // L·ªói client, kh√¥ng th·ª≠ l·∫°i
                            const errorResult = await response.json();
                            throw new Error(errorResult?.error?.message || `L·ªói client: ${response.status}`);
                        }
                    } catch (error) {
                        if (i < 3) { // Ch·ªâ th·ª≠ l·∫°i n·∫øu l√† l·ªói m·∫°ng
                            console.warn(`L·ªói m·∫°ng khi g·ªçi API. Th·ª≠ l·∫°i sau ${delay / 1000}s...`, error);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else {
                            throw error; // N√©m l·ªói cu·ªëi c√πng
                        }
                    }
                }
                throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Gemini API sau nhi·ªÅu l·∫ßn th·ª≠.");
            }
        };

        const generateMockData = () => { return { statuses: [ { id: 'status1', name: '1. Kh√°ch h√†ng M·ªõi', color: 'bg-indigo-400', order: 1, type: 'pipeline' }, { id: 'status2', name: '2. ƒê√£ ChƒÉm s√≥c', color: 'bg-yellow-500', order: 2, type: 'pipeline' }, { id: 'status3', name: '3. Ti·ªÅm nƒÉng Cao', color: 'bg-red-600', order: 3, type: 'pipeline' }, { id: 'status4', name: '4. ƒê√£ k√Ω Hƒê', color: 'bg-green-600', order: 4, type: 'win' }, { id: 'status6', name: '5. ƒê√£ giao xe', color: 'bg-blue-600', order: 5, type: 'delivered' }, { id: 'status5', name: '6. Lostsale', color: 'bg-black', order: 6, type: 'lostsale' }, ], carModels: [ { id: 'model1', name: 'MG ZS' }, { id: 'model2', name: 'MG HS' }, { id: 'model3', name: 'MG RX5' }, { id: 'model4', name: 'MG GT' } ], customerSources: [ { id: 'source1', name: 'Facebook' }, { id: 'source2', name: 'Website' }, { id: 'source3', name: 'Showroom' }, { id: 'source4', name: 'Gi·ªõi thi·ªáu' }, { id: 'source5', name: 'Zalo' } ], customers: [], reminders: [], salesGoals: [], userName: '' }; };

        // ==================== COMPONENTS ====================
        const LoadingSpinner = () => { return React.createElement('div', { className: "flex justify-center items-center py-8" }, [ React.createElement(RefreshCw, { key: 'spinner', className: "w-6 h-6 animate-spin text-indigo-600" }), React.createElement('span', { key: 'text', className: "ml-2 text-gray-600" }, "ƒêang t·∫£i d·ªØ li·ªáu...") ]); };
        const Modal = ({ isOpen, title, onClose, children, maxWidth = 'max-w-lg' }) => { if (!isOpen) return null; const handleBackdropClick = (e) => { if (e.target === e.currentTarget) { onClose(); } }; return React.createElement('div', { className: "fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex justify-center items-start pt-8 sm:pt-16 p-4", onClick: handleBackdropClick }, React.createElement('div', { className: `bg-white rounded-xl shadow-2xl w-full ${maxWidth} transform transition-all duration-300` }, [ React.createElement('div', { key: 'header', className: "p-5 border-b flex justify-between items-center sticky top-0 bg-white z-10" }, [ React.createElement('h3', { key: 'title', className: "text-xl font-bold text-gray-800" }, title), React.createElement('button', { key: 'close', onClick: onClose, className: "text-gray-400 hover:text-gray-600 transition" }, React.createElement(X, { className: "w-6 h-6" })) ]), React.createElement('div', { key: 'content', className: "p-6 max-h-[80vh] overflow-y-auto custom-scrollbar" }, children) ])); };
        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => { return React.createElement(Modal, { isOpen: isOpen, title: title, onClose: onCancel, maxWidth: "max-w-sm" }, [ React.createElement('div', { key: 'content', className: "text-center p-4" }, [ React.createElement(AlertTriangle, { key: 'icon', className: "w-12 h-12 text-red-500 mx-auto mb-4" }), React.createElement('p', { key: 'title', className: "text-lg font-semibold text-gray-800 mb-2" }, title), React.createElement('p', { key: 'message', className: "text-gray-600 mb-6" }, message), React.createElement('div', { key: 'actions', className: "flex justify-center space-x-4" }, [ React.createElement('button', { key: 'cancel', onClick: onCancel, className: "px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition" }, "H·ªßy b·ªè"), React.createElement('button', { key: 'confirm', onClick: onConfirm, className: "px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition" }, "X√°c nh·∫≠n") ]) ]) ]); };
        
        // T√çCH H·ª¢P GEMINI API: Component hi·ªÉn th·ªã k·ªãch b·∫£n
        const ScriptModal = ({ isOpen, isLoading, script, onClose }) => {
            const [copySuccess, setCopySuccess] = useState('');

            const copyToClipboard = () => {
                if (!script) return;
                const textArea = document.createElement("textarea");
                textArea.value = script;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopySuccess('ƒê√£ sao ch√©p!');
                    setTimeout(() => setCopySuccess(''), 2000);
                } catch (err) {
                    setCopySuccess('Sao ch√©p th·∫•t b·∫°i!');
                }
                document.body.removeChild(textArea);
            };

            return React.createElement(Modal, { isOpen: isOpen, title: "‚ú® K·ªãch b·∫£n ChƒÉm s√≥c AI", onClose: onClose, maxWidth: "max-w-xl" },
                React.createElement('div', { className: "space-y-4" },
                    isLoading ?
                        React.createElement('div', { key: 'loading-state', className: "flex flex-col items-center justify-center min-h-[200px]" }, [
                            React.createElement(RefreshCw, { key: 'spinner', className: "w-8 h-8 animate-spin text-indigo-600" }),
                            React.createElement('p', { key: 'text', className: "mt-4 text-gray-600" }, "AI ƒëang ph√¢n t√≠ch v√† t·∫°o k·ªãch b·∫£n...")
                        ]) :
                        React.createElement('div', { key: 'script-content' }, [
                            React.createElement('div', { key: 'script-text', className: "p-4 bg-gray-50 rounded-lg whitespace-pre-wrap text-gray-800 border" }, script),
                            React.createElement('div', { key: 'actions', className: "mt-4 flex justify-end items-center space-x-3" }, [
                                copySuccess && React.createElement('span', { key: 'copy-success-msg', className: "text-sm text-green-600" }, copySuccess),
                                React.createElement('button', { key: 'copy-btn', onClick: copyToClipboard, className: "px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100 transition" }, "Sao ch√©p")
                            ])
                        ])
                )
            );
        };
        
        const InteractionHistory = ({ interactions, onAddInteraction, onDeleteInteraction, userName }) => { /* ... gi·ªØ nguy√™n ... */ const [newInteraction, setNewInteraction] = useState({ type: 'call', notes: '', duration: 0, outcome: 'neutral' }); const [isAdding, setIsAdding] = useState(false); const interactionTypes = [ { value: 'call', label: 'üìû Cu·ªôc g·ªçi', color: 'bg-green-100 text-green-800' }, { value: 'email', label: '‚úâÔ∏è Email', color: 'bg-blue-100 text-blue-800' }, { value: 'meeting', label: 'ü§ù G·∫∑p m·∫∑t', color: 'bg-purple-100 text-purple-800' }, { value: 'test_drive', label: 'üöó L√°i th·ª≠', color: 'bg-orange-100 text-orange-800' }, { value: 'quotation', label: 'üí∞ B√°o gi√°', color: 'bg-indigo-100 text-indigo-800' }, { value: 'other', label: 'üìù Kh√°c', color: 'bg-gray-100 text-gray-800' } ]; const handleAddInteraction = () => { if (!newInteraction.notes.trim()) { alert('Vui l√≤ng nh·∫≠p n·ªôi dung t∆∞∆°ng t√°c'); return; } const interaction = { id: 'int-' + Date.now(), type: newInteraction.type, date: Date.now(), notes: newInteraction.notes, duration: newInteraction.duration || 0, outcome: newInteraction.outcome }; onAddInteraction(interaction); setNewInteraction({ type: 'call', notes: '', duration: 0, outcome: 'neutral' }); setIsAdding(false); }; return React.createElement('div', { className: "space-y-4" }, [ React.createElement('div', { key: 'header', className: "flex justify-between items-center" }, [ React.createElement('h4', { key: 'title', className: "font-semibold text-gray-800" }, `L·ªãch s·ª≠ T∆∞∆°ng t√°c (${interactions.length})`), React.createElement('button', { key: 'add-button', onClick: () => setIsAdding(!isAdding), className: "px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition flex items-center" }, [ React.createElement(Plus, { key: 'icon', className: "w-4 h-4 mr-1" }), "Th√™m" ]) ]), isAdding && React.createElement('div', { key: 'add-form', className: "p-4 border rounded-lg bg-gray-50" }, [ React.createElement('div', { key: 'form-header', className: "flex justify-between items-center mb-3" }, [ React.createElement('h5', { key: 'title', className: "font-medium" }, "T∆∞∆°ng t√°c m·ªõi"), React.createElement('button', { key: 'close-button', onClick: () => setIsAdding(false) }, React.createElement(X, { className: "w-4 h-4" })) ]), React.createElement('div', { key: 'form-content', className: "space-y-3" }, [ React.createElement('div', { key: 'type-duration', className: "grid grid-cols-2 gap-3" }, [ React.createElement('select', { key: 'type', value: newInteraction.type, onChange: (e) => setNewInteraction(prev => ({ ...prev, type: e.target.value })), className: "p-2 border rounded-lg" }, interactionTypes.map(type => React.createElement('option', { key: type.value, value: type.value }, type.label))), React.createElement('div', { key: 'duration', className: "flex items-center space-x-2" }, [ React.createElement('input', { key: 'duration-input', type: "number", placeholder: "Ph√∫t", value: newInteraction.duration, onChange: (e) => setNewInteraction(prev => ({ ...prev, duration: parseInt(e.target.value) || 0 })), className: "w-full p-2 border rounded-lg", min: "0" })]) ]), React.createElement('textarea', { key: 'notes', placeholder: "M√¥ t·∫£...", value: newInteraction.notes, onChange: (e) => setNewInteraction(prev => ({ ...prev, notes: e.target.value })), rows: 3, className: "w-full p-2 border rounded-lg" }), React.createElement('select', { key: 'outcome', value: newInteraction.outcome, onChange: (e) => setNewInteraction(prev => ({ ...prev, outcome: e.target.value })), className: "w-full p-2 border rounded-lg" }, [ React.createElement('option', { key: 'positive', value: "positive" }, "‚úÖ T√≠ch c·ª±c"), React.createElement('option', { key: 'neutral', value: "neutral" }, "‚ö™ Trung l·∫≠p"), React.createElement('option', { key: 'negative', value: "negative" }, "‚ùå Ti√™u c·ª±c") ]), React.createElement('button', { key: 'submit', onClick: handleAddInteraction, className: "w-full py-2 bg-green-600 text-white rounded-lg" }, "L∆∞u") ]) ]), React.createElement('div', { key: 'interactions-list', className: "space-y-3 max-h-80 overflow-y-auto" }, interactions.length === 0 ? React.createElement('div', { key: 'empty-state', className: "text-center py-8 text-gray-500" }, [ React.createElement('div', { key: 'icon', className: "text-4xl mb-2" }, "üìù"), React.createElement('p', { key: 'message1' }, "Ch∆∞a c√≥ t∆∞∆°ng t√°c") ]) : interactions.sort((a, b) => b.date - a.date).map(interaction => { const typeConfig = interactionTypes.find(t => t.value === interaction.type); const outcomeIcons = { positive: '‚úÖ', neutral: '‚ö™', negative: '‚ùå' }; return React.createElement('div', { key: interaction.id, className: "p-3 border rounded-lg bg-white" }, [ React.createElement('div', { key: 'header', className: "flex justify-between items-start mb-2" }, [ React.createElement('div', { key: 'type-date', className: "flex items-center space-x-2" }, [ React.createElement('span', { key: 'type', className: `px-2 py-1 text-xs rounded-full ${typeConfig?.color}` }, typeConfig?.label), React.createElement('span', { key: 'date', className: "text-xs text-gray-500" }, formatDateTime(interaction.date)) ]), React.createElement('div', { key: 'actions-duration', className: "flex items-center space-x-2" }, [ interaction.duration > 0 && React.createElement('span', { key: 'duration', className: "text-xs text-gray-500" }, `${interaction.duration} ph√∫t`), React.createElement('button', { key: 'delete', onClick: () => onDeleteInteraction(interaction.id) }, React.createElement(Trash2, { className: "w-4 h-4" })) ]) ]), React.createElement('div', { key: 'content', className: "flex items-start space-x-2" }, [ React.createElement('span', { key: 'outcome', className: "text-lg mt-0.5" }, outcomeIcons[interaction.outcome]), React.createElement('div', { key: 'notes', className: "flex-1" }, [ React.createElement('p', { key: 'notes-text' }, interaction.notes), React.createElement('p', { key: 'user', className: "text-xs text-gray-400 mt-1" }, `b·ªüi: ${userName || 'NVKD'}`) ]) ]) ]); })) ]); };
        const CustomerCard = ({ customer, statuses, onEdit, onDelete, onStatusChange, onAddInteraction, onDeleteInteraction, userName, onGenerateScript }) => { const [showDetails, setShowDetails] = useState(false); const [showInteractions, setShowInteractions] = useState(false); const status = statuses.find(s => s.id === customer.statusId); const tierConfig = CUSTOMER_TIERS.find(t => t.value === customer.tier); const totalInteractions = customer.interactions ? customer.interactions.length : 0; const lastInteraction = customer.interactions && customer.interactions.length > 0 ? customer.interactions.sort((a, b) => b.date - a.date)[0] : null; const handleStatusChange = (newStatusId) => { onStatusChange(customer.id, newStatusId); }; return React.createElement('div', { className: "bg-white rounded-xl shadow-sm border hover:shadow-md transition-all" }, [ React.createElement('div', { key: 'header', className: "p-4 border-b" }, [ React.createElement('div', { key: 'name-tier', className: "flex justify-between items-start mb-2" }, [ React.createElement('h3', { key: 'name', className: "font-semibold text-lg truncate" }, customer.name), React.createElement('span', { key: 'tier', className: `text-xs font-medium px-2 py-1 rounded-full ${tierConfig?.color} border border-current` }, tierConfig?.label?.split(' - ')[0]) ]), React.createElement('div', { key: 'contact-info', className: "flex flex-wrap gap-2 text-sm" }, [ React.createElement('div', { key: 'phone', className: "flex items-center" }, [ React.createElement(Phone, { key: 'phone-icon', className: "w-4 h-4 mr-1" }), customer.phone ]), customer.email && React.createElement('div', { key: 'email', className: "flex items-center" }, [ React.createElement(Mail, { key: 'email-icon', className: "w-4 h-4 mr-1" }), React.createElement('span', { key: 'email-text', className: "truncate max-w-[120px]" }, customer.email) ]) ]) ]), React.createElement('div', { key: 'body', className: "p-4 space-y-3" }, [ React.createElement('div', { key: 'car-source', className: "grid grid-cols-2 gap-4 text-sm" }, [ React.createElement('div', { key: 'car', className: "flex items-center" }, [ React.createElement(Car, { key: 'car-icon', className: "w-4 h-4 mr-2" }), React.createElement('span', { key: 'car-text' }, customer.carModel || '---') ]), React.createElement('div', { key: 'source', className: "flex items-center" }, [ React.createElement(Layers, { key: 'source-icon', className: "w-4 h-4 mr-2" }), React.createElement('span', { key: 'source-text' }, customer.source || '---') ]) ]), React.createElement('div', { key: 'city-value', className: "grid grid-cols-2 gap-4 text-sm" }, [ React.createElement('div', { key: 'city', className: "flex items-center" }, [ React.createElement(MapPin, { key: 'city-icon', className: "w-4 h-4 mr-2" }), React.createElement('span', { key: 'city-text' }, customer.city || '---') ]), customer.salesValue > 0 && React.createElement('div', { key: 'value', className: "flex items-center" }, [ React.createElement(DollarSign, { key: 'value-icon', className: "w-4 h-4 mr-2 text-green-500" }), React.createElement('span', { key: 'value-text', className: "font-medium text-green-600" }, formatCurrency(customer.salesValue)) ]) ]), React.createElement('div', { key: 'status', className: "space-y-2" }, [ React.createElement('label', { key: 'status-label', className: "block text-xs font-medium" }, "Tr·∫°ng th√°i:"), React.createElement('select', { key: 'status-select', value: customer.statusId, onChange: (e) => handleStatusChange(e.target.value), className: "w-full p-2 border rounded-lg text-sm" }, statuses.sort((a, b) => a.order - b.order).map(status => React.createElement('option', { key: status.id, value: status.id }, status.name))) ]), React.createElement('div', { key: 'interactions-summary', className: "border-t pt-3" }, [ React.createElement('button', { key: 'interactions-button', onClick: () => setShowInteractions(!showInteractions), className: "w-full flex justify-between items-center p-2 text-sm rounded-lg" }, [ React.createElement('span', { key: 'text', className: "flex items-center" }, [ React.createElement(Clock, { key: 'icon', className: "w-4 h-4 mr-2" }), `L·ªãch s·ª≠ (${totalInteractions})` ]), React.createElement('span', { key: 'arrow' }, showInteractions ? '‚ñ≤' : '‚ñº') ]), lastInteraction && React.createElement('div', { key: 'last-interaction', className: "mt-2 p-2 bg-gray-50 rounded-lg text-xs" }, [ React.createElement('p', { key: 'date' }, `Cu·ªëi: ${formatDateTime(lastInteraction.date)}`), React.createElement('p', { key: 'notes', className: "truncate" }, lastInteraction.notes) ]) ]) ]), showInteractions && React.createElement('div', { key: 'interactions-panel', className: "border-t p-4 bg-gray-50" }, React.createElement(InteractionHistory, { interactions: customer.interactions || [], onAddInteraction: (interaction) => onAddInteraction(customer.id, interaction), onDeleteInteraction: (interactionId) => onDeleteInteraction(customer.id, interactionId), userName: userName })), React.createElement('div', { key: 'footer', className: "p-4 border-t bg-gray-50 rounded-b-xl" }, [ React.createElement('div', { key: 'footer-content', className: "flex justify-between items-center" }, [ React.createElement('button', { key: 'details-button', onClick: () => setShowDetails(!showDetails), className: "text-indigo-600 text-sm font-medium" }, [ showDetails ? '·∫®n' : 'Xem chi ti·∫øt', React.createElement('span', { key: 'arrow', className: "ml-1" }, showDetails ? '‚ñ≤' : '‚ñº') ]), React.createElement('div', { key: 'actions', className: "flex space-x-2 items-center" }, [ 
            React.createElement('button', { key: 'script-btn', onClick: () => onGenerateScript(customer), className: "p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg", title: "T·∫°o k·ªãch b·∫£n chƒÉm s√≥c AI" }, "‚ú®"),
            React.createElement('button', { key: 'edit-button', onClick: () => onEdit(customer), className: "p-2" }, "‚úèÔ∏è"), React.createElement('button', { key: 'delete-button', onClick: () => onDelete(customer.id), className: "p-2" }, "üóëÔ∏è") ]) ]), showDetails && React.createElement('div', { key: 'details', className: "mt-4 p-4 bg-white border rounded-lg space-y-3" }, [ React.createElement('div', { key: 'dates', className: "grid grid-cols-2 gap-4 text-sm" }, [ React.createElement('div', { key: 'created' }, [ React.createElement('span', { key: 'label' }, "Ng√†y t·∫°o:"), React.createElement('div', { key: 'value', className: "font-medium" }, formatDate(customer.createdDate)) ]), React.createElement('div', { key: 'contact' }, [ React.createElement('span', { key: 'label' }, "Li√™n h·ªá cu·ªëi:"), React.createElement('div', { key: 'value', className: "font-medium" }, formatDate(customer.lastContactDate)) ]) ]), customer.notes && React.createElement('div', { key: 'notes' }, [ React.createElement('span', { key: 'label', className: "text-sm" }, "Ghi ch√∫:"), React.createElement('p', { key: 'value', className: "mt-1" }, customer.notes) ]) ]) ]) ]); };
        const CustomerForm = ({ isOpen, onClose, onSave, customer, statuses, carModels, customerSources }) => { const [formData, setFormData] = useState({ name: '', phone: '', email: '', carModel: '', source: '', statusId: '', city: '', notes: '', salesValue: 0, tier: 'COLD' }); const [errors, setErrors] = useState({}); useEffect(() => { if (customer) { setFormData({ name: customer.name || '', phone: customer.phone || '', email: customer.email || '', carModel: customer.carModel || '', source: customer.source || '', statusId: customer.statusId || (statuses[0]?.id || ''), city: customer.city || '', notes: customer.notes || '', salesValue: customer.salesValue || 0, tier: customer.tier || 'COLD' }); } else { setFormData({ name: '', phone: '', email: '', carModel: '', source: '', statusId: statuses[0]?.id || '', city: '', notes: '', salesValue: 0, tier: 'COLD' }); } setErrors({}); }, [customer, isOpen, statuses]); const validateForm = () => { const newErrors = {}; if (!formData.name.trim()) { newErrors.name = 'Vui l√≤ng nh·∫≠p t√™n'; } if (!formData.phone.trim()) { newErrors.phone = 'Vui l√≤ng nh·∫≠p SƒêT'; } else if (!/^(0|\+84)[3|5|7|8|9][0-9]{8}$/.test(formData.phone.replace(/\s/g, ''))) { newErrors.phone = 'SƒêT kh√¥ng h·ª£p l·ªá'; } if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) { newErrors.email = 'Email kh√¥ng h·ª£p l·ªá'; } setErrors(newErrors); return Object.keys(newErrors).length === 0; }; const handleSubmit = (e) => { e.preventDefault(); if (!validateForm()) { return; } const customerData = { ...formData, salesValue: Number(formData.salesValue) || 0, createdDate: customer ? customer.createdDate : Date.now(), lastContactDate: Date.now(), interactions: customer ? customer.interactions || [] : [] }; onSave(customerData); onClose(); }; const handleChange = (field, value) => { setFormData(prev => ({ ...prev, [field]: value })); if (errors[field]) { setErrors(prev => ({ ...prev, [field]: '' })); } }; return React.createElement(Modal, { isOpen: isOpen, title: customer ? 'Ch·ªânh s·ª≠a' : 'Th√™m Kh√°ch h√†ng', onClose: onClose, maxWidth: "max-w-2xl" }, React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" }, [ React.createElement('div', { key: 'personal-info', className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [ React.createElement('div', { key: 'name' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "T√™n *"), React.createElement('input', { key: 'input', type: "text", value: formData.name, onChange: (e) => handleChange('name', e.target.value), className: `w-full p-2 border rounded-lg ${errors.name ? 'border-red-500' : ''}` }), errors.name && React.createElement('p', { key: 'error', className: "mt-1 text-sm text-red-600" }, errors.name) ]), React.createElement('div', { key: 'phone' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "SƒêT *"), React.createElement('input', { key: 'input', type: "tel", value: formData.phone, onChange: (e) => handleChange('phone', e.target.value), className: `w-full p-2 border rounded-lg ${errors.phone ? 'border-red-500' : ''}` }), errors.phone && React.createElement('p', { key: 'error', className: "mt-1 text-sm text-red-600" }, errors.phone) ]) ]), React.createElement('div', { key: 'contact-info', className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [ React.createElement('div', { key: 'email' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Email"), React.createElement('input', { key: 'input', type: "email", value: formData.email, onChange: (e) => handleChange('email', e.target.value), className: `w-full p-2 border rounded-lg ${errors.email ? 'border-red-500' : ''}` }), errors.email && React.createElement('p', { key: 'error', className: "mt-1 text-sm text-red-600" }, errors.email) ]), React.createElement('div', { key: 'city' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Th√†nh ph·ªë"), React.createElement('select', { key: 'select', value: formData.city, onChange: (e) => handleChange('city', e.target.value), className: "w-full p-2 border rounded-lg" }, [ React.createElement('option', { key: 'empty', value: "" }, "Ch·ªçn TP"), ...VIETNAM_CITIES.map(city => React.createElement('option', { key: city, value: city }, city)) ]) ]) ]), React.createElement('div', { key: 'car-source-info', className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [ React.createElement('div', { key: 'carModel' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "D√≤ng xe"), React.createElement('select', { key: 'select', value: formData.carModel, onChange: (e) => handleChange('carModel', e.target.value), className: "w-full p-2 border rounded-lg" }, [ React.createElement('option', { key: 'empty', value: "" }, "Ch·ªçn xe"), ...carModels.map(model => React.createElement('option', { key: model.id, value: model.name }, model.name)) ]) ]), React.createElement('div', { key: 'source' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Ngu·ªìn"), React.createElement('select', { key: 'select', value: formData.source, onChange: (e) => handleChange('source', e.target.value), className: "w-full p-2 border rounded-lg" }, [ React.createElement('option', { key: 'empty', value: "" }, "Ch·ªçn ngu·ªìn"), ...customerSources.map(source => React.createElement('option', { key: source.id, value: source.name }, source.name)) ]) ]) ]), React.createElement('div', { key: 'status-tier', className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [ React.createElement('div', { key: 'status' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Tr·∫°ng th√°i"), React.createElement('select', { key: 'select', value: formData.statusId, onChange: (e) => handleChange('statusId', e.target.value), className: "w-full p-2 border rounded-lg" }, statuses.sort((a, b) => a.order - b.order).map(status => React.createElement('option', { key: status.id, value: status.id }, status.name))) ]), React.createElement('div', { key: 'tier' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Ph√¢n lo·∫°i"), React.createElement('select', { key: 'select', value: formData.tier, onChange: (e) => handleChange('tier', e.target.value), className: "w-full p-2 border rounded-lg" }, CUSTOMER_TIERS.map(tier => React.createElement('option', { key: tier.value, value: tier.value }, tier.label))) ]) ]), React.createElement('div', { key: 'sales-value' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Gi√° tr·ªã (VNƒê)"), React.createElement('input', { key: 'input', type: "number", value: formData.salesValue, onChange: (e) => handleChange('salesValue', e.target.value), className: "w-full p-2 border rounded-lg", min: "0" }) ]), React.createElement('div', { key: 'notes' }, [ React.createElement('label', { key: 'label', className: "block text-sm font-medium" }, "Ghi ch√∫"), React.createElement('textarea', { key: 'textarea', value: formData.notes, onChange: (e) => handleChange('notes', e.target.value), rows: 3, className: "w-full p-2 border rounded-lg" }) ]), React.createElement('div', { key: 'actions', className: "flex justify-end space-x-3 pt-4 border-t" }, [ React.createElement('button', { key: 'cancel', type: "button", onClick: onClose, className: "px-4 py-2 border rounded-lg" }, "H·ªßy"), React.createElement('button', { key: 'save', type: "submit", className: "px-6 py-2 bg-indigo-600 text-white rounded-lg" }, [ React.createElement(Save, { key: 'icon', className: "w-4 h-4 mr-2" }), customer ? 'C·∫≠p nh·∫≠t' : 'Th√™m' ]) ]) ])); };
        const KanbanView = ({ customers, statuses, onCustomerEdit, onCustomerUpdate, onCustomerDelete, onAddInteraction, onDeleteInteraction, userName, onGenerateScript }) => { const [draggedCustomer, setDraggedCustomer] = useState(null); const [dragOverStatus, setDragOverStatus] = useState(null); const handleDragStart = (e, customer) => { setDraggedCustomer(customer); e.dataTransfer.effectAllowed = 'move'; }; const handleDragOver = (e, statusId) => { e.preventDefault(); setDragOverStatus(statusId); }; const handleDragLeave = (e) => { e.preventDefault(); setDragOverStatus(null); }; const handleDrop = (e, targetStatusId) => { e.preventDefault(); setDragOverStatus(null); if (draggedCustomer && draggedCustomer.statusId !== targetStatusId) { onCustomerUpdate(draggedCustomer.id, { statusId: targetStatusId }); } setDraggedCustomer(null); }; const customersByStatus = useMemo(() => { const grouped = {}; statuses.forEach(status => { grouped[status.id] = customers.filter(customer => customer.statusId === status.id); }); return grouped; }, [customers, statuses]); const getStatusStats = (statusId) => { const statusCustomers = customersByStatus[statusId] || []; const totalValue = statusCustomers.reduce((sum, customer) => sum + (customer.salesValue || 0), 0); return { count: statusCustomers.length, totalValue: totalValue }; }; return React.createElement('div', { className: "kanban-container overflow-x-auto pb-6" }, React.createElement('div', { className: "flex space-x-4 min-w-max px-4" }, statuses.sort((a, b) => a.order - b.order).map(status => { const stats = getStatusStats(status.id); const isDragOver = dragOverStatus === status.id; return React.createElement('div', { key: status.id, className: `kanban-column flex-shrink-0 w-72 bg-gray-50 rounded-xl p-4 transition-all ${isDragOver ? 'drag-over' : ''}`, onDragOver: (e) => handleDragOver(e, status.id), onDragLeave: handleDragLeave, onDrop: (e) => handleDrop(e, status.id) }, [ React.createElement('div', { key: 'header', className: "mb-4" }, [ React.createElement('div', { key: 'title-stats', className: "flex justify-between items-center mb-2" }, [ React.createElement('h3', { key: 'title', className: "font-semibold flex items-center" }, [ React.createElement('span', { key: 'color-dot', className: `w-3 h-3 rounded-full ${status.color} mr-2` }), status.name ]), React.createElement('span', { key: 'count', className: "bg-white px-2 py-1 rounded-full text-sm font-medium" }, stats.count) ]), React.createElement('div', { key: 'stats', className: "text-xs text-gray-500 space-y-1" }, [ React.createElement('div', { key: 'value', className: "flex justify-between" }, [ React.createElement('span', { key: 'label' }, "Gi√° tr·ªã:"), React.createElement('span', { key: 'amount', className: "font-medium text-green-600" }, formatCurrency(stats.totalValue)) ]) ]) ]), React.createElement('div', { key: 'customers', className: "space-y-3 min-h-[200px] max-h-[70vh] overflow-y-auto" }, customersByStatus[status.id]?.map(customer => React.createElement('div', { key: customer.id, draggable: true, onDragStart: (e) => handleDragStart(e, customer), className: "transform transition-transform hover:scale-[1.02]" }, React.createElement(CustomerCard, { customer: customer, statuses: statuses, onEdit: onCustomerEdit, onDelete: onCustomerDelete, onStatusChange: (customerId, newStatusId) => onCustomerUpdate(customerId, { statusId: newStatusId }), onAddInteraction: onAddInteraction, onDeleteInteraction: onDeleteInteraction, userName: userName, onGenerateScript: onGenerateScript })))), (!customersByStatus[status.id] || customersByStatus[status.id].length === 0) && React.createElement('div', { key: 'empty', className: "text-center py-8 text-gray-400" }, [ React.createElement('div', { key: 'icon', className: "text-2xl mb-2" }, "üìã"), React.createElement('p', { key: 'text' }, "Tr·ªëng"), React.createElement('p', { key: 'hint', className: "text-xs mt-1" }, "K√©o v√†o ƒë√¢y") ]) ]); }))); };
        const ListView = ({ customers, statuses, onCustomerEdit, onCustomerDelete, onGenerateScript }) => { const [sortField, setSortField] = useState('lastContactDate'); const [sortDirection, setSortDirection] = useState('desc'); const [filterTier, setFilterTier] = useState('all'); const [filterStatus, setFilterStatus] = useState('all'); const processedCustomers = useMemo(() => { let filtered = [...customers]; if (filterTier !== 'all') { filtered = filtered.filter(customer => customer.tier === filterTier); } if (filterStatus !== 'all') { filtered = filtered.filter(customer => customer.statusId === filterStatus); } filtered.sort((a, b) => { let aValue = a[sortField]; let bValue = b[sortField]; if (sortField === 'lastContactDate' || sortField === 'createdDate') { aValue = aValue || 0; bValue = bValue || 0; } else if (sortField === 'name') { aValue = (aValue || '').toLowerCase(); bValue = (bValue || '').toLowerCase(); } else if (sortField === 'salesValue') { aValue = aValue || 0; bValue = bValue || 0; } if (sortDirection === 'asc') { return aValue < bValue ? -1 : aValue > bValue ? 1 : 0; } else { return aValue > bValue ? -1 : aValue < bValue ? 1 : 0; } }); return filtered; }, [customers, sortField, sortDirection, filterTier, filterStatus]); const handleSort = (field) => { if (sortField === field) { setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc'); } else { setSortField(field); setSortDirection('desc'); } }; const SortableHeader = ({ field, children }) => { const isActive = sortField === field; return React.createElement('th', { className: "px-4 py-3 text-left text-xs font-medium uppercase cursor-pointer", onClick: () => handleSort(field) }, [ React.createElement('div', { key: 'content', className: "flex items-center" }, [ React.createElement('span', { key: 'text' }, children), isActive && React.createElement('span', { key: 'arrow' }, sortDirection === 'asc' ? '‚Üë' : '‚Üì') ]) ]); }; return React.createElement('div', { className: "bg-white rounded-xl shadow-sm border overflow-hidden" }, [ React.createElement('div', { key: 'filters', className: "p-4 border-b bg-gray-50" }, [ React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4" }, [ React.createElement('div', { key: 'tier-filter' }, [ React.createElement('label', { className: "block text-sm font-medium" }, "Ph√¢n lo·∫°i"), React.createElement('select', { value: filterTier, onChange: (e) => setFilterTier(e.target.value), className: "w-full p-2 border rounded-lg" }, [ React.createElement('option', { key: 'all', value: "all" }, "T·∫•t c·∫£"), ...CUSTOMER_TIERS.map(tier => React.createElement('option', { key: tier.value, value: tier.value }, tier.label)) ]) ]), React.createElement('div', { key: 'status-filter' }, [ React.createElement('label', { className: "block text-sm font-medium" }, "Tr·∫°ng th√°i"), React.createElement('select', { value: filterStatus, onChange: (e) => setFilterStatus(e.target.value), className: "w-full p-2 border rounded-lg" }, [ React.createElement('option', { key: 'all', value: "all" }, "T·∫•t c·∫£"), ...statuses.map(status => React.createElement('option', { key: status.id, value: status.id }, status.name)) ]) ]), React.createElement('div', { key: 'stats', className: "flex items-center justify-end" }, [ React.createElement('span', { className: "text-sm" }, `Hi·ªÉn th·ªã ${processedCustomers.length} / ${customers.length}`) ]) ]) ]), React.createElement('div', { key: 'table', className: "overflow-x-auto" }, React.createElement('table', { className: "min-w-full divide-y" }, [ React.createElement('thead', { key: 'header', className: "bg-gray-50" }, React.createElement('tr', {}, [ React.createElement(SortableHeader, { key: 'name', field: "name" }, "Kh√°ch h√†ng"), React.createElement(SortableHeader, { key: 'phone', field: "phone" }, "SƒêT"), React.createElement(SortableHeader, { key: 'carModel', field: "carModel" }, "D√≤ng xe"), React.createElement(SortableHeader, { key: 'status', field: "statusId" }, "Tr·∫°ng th√°i"), React.createElement(SortableHeader, { key: 'tier', field: "tier" }, "Ph√¢n lo·∫°i"), React.createElement(SortableHeader, { key: 'salesValue', field: "salesValue" }, "Gi√° tr·ªã"), React.createElement(SortableHeader, { key: 'lastContactDate', field: "lastContactDate" }, "Li√™n h·ªá cu·ªëi"), React.createElement('th', { key: 'actions', className: "px-4 py-3" }, "") ])), React.createElement('tbody', { key: 'body', className: "bg-white divide-y" }, processedCustomers.length === 0 ? React.createElement('tr', { key: 'empty' }, React.createElement('td', { colSpan: 8, className: "px-4 py-8 text-center" }, [ React.createElement('div', { key: 'icon', className: "text-4xl mb-2" }, "üìã"), React.createElement('p', { key: 'text' }, "Kh√¥ng c√≥ kh√°ch h√†ng") ])) : processedCustomers.map(customer => { const status = statuses.find(s => s.id === customer.statusId); const tierConfig = CUSTOMER_TIERS.find(t => t.value === customer.tier); return React.createElement('tr', { key: customer.id, className: "hover:bg-gray-50" }, [ React.createElement('td', { key: 'name', className: "px-4 py-4" }, [ React.createElement('div', { className: "font-medium" }, customer.name), customer.email && React.createElement('div', { className: "text-sm truncate max-w-[200px]" }, customer.email) ]), React.createElement('td', { key: 'phone', className: "px-4 py-4" }, customer.phone), React.createElement('td', { key: 'carModel', className: "px-4 py-4" }, customer.carModel || '---'), React.createElement('td', { key: 'status', className: "px-4 py-4" }, React.createElement('span', { className: `px-2.5 py-0.5 rounded-full text-xs font-medium ${status?.color}` }, status?.name || '---')), React.createElement('td', { key: 'tier', className: "px-4 py-4 text-sm" }, React.createElement('span', { className: tierConfig?.color }, tierConfig?.label?.split(' - ')[0])), React.createElement('td', { key: 'salesValue', className: "px-4 py-4 font-medium", style: { color: customer.salesValue > 0 ? '#059669' : '' } }, formatCurrency(customer.salesValue)), React.createElement('td', { key: 'lastContactDate', className: "px-4 py-4 text-sm" }, formatDate(customer.lastContactDate)), React.createElement('td', { key: 'actions', className: "px-4 py-4 text-sm font-medium flex items-center space-x-3" }, [ 
            React.createElement('button', { key: 'script', onClick: () => onGenerateScript(customer), className: "text-indigo-600 hover:text-indigo-900", title: "T·∫°o k·ªãch b·∫£n AI" }, "‚ú®"),
            React.createElement('button', { key: 'edit', onClick: () => onCustomerEdit(customer) }, "S·ª≠a"), 
            React.createElement('button', { key: 'delete', onClick: () => onCustomerDelete(customer.id) }, "X√≥a") 
        ]) ]); })) ])) ]); };
        const Dashboard = ({ customers, statuses, carModels, reminders }) => { const [selectedPeriod, setSelectedPeriod] = useState('month'); const metrics = useMemo(() => { const now = Date.now(); const oneDay = 24 * 60 * 60 * 1000; let periodStart; switch (selectedPeriod) { case 'week': periodStart = now - 7 * oneDay; break; case 'month': periodStart = now - 30 * oneDay; break; case 'quarter': periodStart = now - 90 * oneDay; break; default: periodStart = now - 30 * oneDay; } const periodCustomers = customers.filter(c => c.createdDate >= periodStart); const deliveredCustomers = customers.filter(c => { const status = statuses.find(s => s.id === c.statusId); return status?.type === 'delivered'; }); const potentialCustomers = customers.filter(c => { const status = statuses.find(s => s.id === c.statusId); return status?.type === 'pipeline' || status?.type === 'win'; }); const totalRevenue = deliveredCustomers.reduce((sum, c) => sum + (c.salesValue || 0), 0); const potentialRevenue = potentialCustomers.reduce((sum, c) => sum + (c.salesValue || 0), 0); const totalPotentialCount = potentialCustomers.length + deliveredCustomers.length; const conversionRate = totalPotentialCount > 0 ? (deliveredCustomers.length / totalPotentialCount) * 100 : 0; const tierDistribution = CUSTOMER_TIERS.map(tier => ({ tier: tier.value, label: tier.label, count: customers.filter(c => c.tier === tier.value).length, color: tier.color.replace('text-', 'bg-') })); const statusDistribution = statuses.map(status => ({ status: status.name, count: customers.filter(c => c.statusId === status.id).length, color: status.color })); const carModelDistribution = carModels.map(model => ({ model: model.name, count: customers.filter(c => c.carModel === model.name).length })); return { totalCustomers: customers.length, periodNewCustomers: periodCustomers.length, deliveredCount: deliveredCustomers.length, totalPotentialCount, totalRevenue, potentialRevenue, conversionRate: Math.round(conversionRate), tierDistribution, statusDistribution, carModelDistribution, pendingReminders: reminders.filter(r => !r.completed).length }; }, [customers, statuses, carModels, selectedPeriod, reminders]); const tierChartRef = useRef(null); const statusChartRef = useRef(null); const carModelChartRef = useRef(null); useEffect(() => { [tierChartRef, statusChartRef, carModelChartRef].forEach(ref => { if (ref.current && ref.current.chartInstance) { ref.current.chartInstance.destroy(); } }); if (tierChartRef.current && metrics.tierDistribution.length > 0) { const ctx = tierChartRef.current.getContext('2d'); tierChartRef.current.chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: metrics.tierDistribution.map(t => t.label.split(' - ')[0]), datasets: [{ data: metrics.tierDistribution.map(t => t.count), backgroundColor: ['#DC2626', '#D97706', '#4F46E5', '#6B7280'], borderWidth: 2, borderColor: '#FFFFFF' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } } } }); } if (statusChartRef.current && metrics.statusDistribution.length > 0) { const ctx = statusChartRef.current.getContext('2d'); statusChartRef.current.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: metrics.statusDistribution.map(s => s.status), datasets: [{ label: 'S·ªë l∆∞·ª£ng', data: metrics.statusDistribution.map(s => s.count), backgroundColor: ['#4F46E5', '#D97706', '#DC2626', '#059669', '#2563EB', '#000000'], borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); } if (carModelChartRef.current && metrics.carModelDistribution.length > 0) { const ctx = carModelChartRef.current.getContext('2d'); carModelChartRef.current.chartInstance = new Chart(ctx, { type: 'pie', data: { labels: metrics.carModelDistribution.map(m => m.model), datasets: [{ data: metrics.carModelDistribution.map(m => m.count), backgroundColor: ['#4F46E5', '#EF4444', '#10B981', '#F59E0B'], borderWidth: 2, borderColor: '#FFFFFF' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } } } }); } return () => { [tierChartRef, statusChartRef, carModelChartRef].forEach(ref => { if (ref.current && ref.current.chartInstance) { ref.current.chartInstance.destroy(); } }); }; }, [metrics]); const MetricCard = ({ title, value, subtitle, icon, color = 'indigo' }) => { const colorClasses = { indigo: 'bg-indigo-50 text-indigo-600', green: 'bg-green-50 text-green-600', red: 'bg-red-50 text-red-600', yellow: 'bg-yellow-50 text-yellow-600', blue: 'bg-blue-50 text-blue-600' }; return React.createElement('div', { className: "bg-white rounded-xl p-6 shadow-sm border" }, [ React.createElement('div', { key: 'header', className: "flex items-center justify-between mb-4" }, [ React.createElement('div', { key: 'icon', className: `p-3 rounded-lg ${colorClasses[color]}` }, icon), React.createElement('div', { key: 'period-badge', className: "text-xs font-medium px-2 py-1 bg-gray-100 rounded-full" }, selectedPeriod === 'week' ? '7 ng√†y' : selectedPeriod === 'month' ? '30 ng√†y' : '90 ng√†y') ]), React.createElement('div', { key: 'content' }, [ React.createElement('h3', { key: 'title', className: "text-sm font-medium" }, title), React.createElement('p', { key: 'value', className: "text-2xl font-bold mb-1" }, value), subtitle && React.createElement('p', { key: 'subtitle', className: "text-sm" }, subtitle) ]) ]); }; return React.createElement('div', { className: "space-y-6" }, [ React.createElement('div', { key: 'period-selector', className: "flex justify-between items-center" }, [ React.createElement('h2', { key: 'title', className: "text-2xl font-bold" }, "T·ªïng quan"), React.createElement('select', { key: 'period-select', value: selectedPeriod, onChange: (e) => setSelectedPeriod(e.target.value), className: "p-2 border rounded-lg" }, [ React.createElement('option', { key: 'week', value: "week" }, "7 ng√†y"), React.createElement('option', { key: 'month', value: "month" }, "30 ng√†y"), React.createElement('option', { key: 'quarter', value: "quarter" }, "90 ng√†y") ]) ]), React.createElement('div', { key: 'metrics-grid', className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" }, [ React.createElement(MetricCard, { key: 'total-customers', title: "T·ªïng KH", value: metrics.totalCustomers, subtitle: `${metrics.periodNewCustomers} m·ªõi`, icon: React.createElement(Users, { className: "w-6 h-6" }), color: "indigo" }), React.createElement(MetricCard, { key: 'revenue', title: "Doanh s·ªë", value: formatCurrency(metrics.totalRevenue), subtitle: `${metrics.deliveredCount} xe giao`, icon: React.createElement(DollarSign, { className: "w-6 h-6" }), color: "green" }), React.createElement(MetricCard, { key: 'conversion', title: "T·ª∑ l·ªá ch·ªët", value: `${metrics.conversionRate}%`, subtitle: `${metrics.deliveredCount}/${metrics.totalPotentialCount} KHTN`, icon: React.createElement(Target, { className: "w-6 h-6" }), color: "blue" }), React.createElement(MetricCard, { key: 'potential', title: "Ti·ªÅm nƒÉng", value: formatCurrency(metrics.potentialRevenue), subtitle: `${metrics.pendingReminders} nh·∫Øc h·∫πn`, icon: React.createElement(TrendingUp, { className: "w-6 h-6" }), color: "yellow" }) ]), React.createElement('div', { key: 'charts-grid', className: "grid grid-cols-1 lg:grid-cols-2 gap-6" }, [ React.createElement('div', { key: 'tier-chart', className: "bg-white rounded-xl p-6 shadow-sm border" }, [ React.createElement('h3', { key: 'title', className: "text-lg font-semibold mb-4" }, "Ph√¢n lo·∫°i"), React.createElement('div', { key: 'chart', className: "chart-container" }, React.createElement('canvas', { ref: tierChartRef })) ]), React.createElement('div', { key: 'status-chart', className: "bg-white rounded-xl p-6 shadow-sm border" }, [ React.createElement('h3', { key: 'title', className: "text-lg font-semibold mb-4" }, "Tr·∫°ng th√°i"), React.createElement('div', { key: 'chart', className: "chart-container" }, React.createElement('canvas', { ref: statusChartRef })) ]) ]), React.createElement('div', { key: 'car-model-chart', className: "bg-white rounded-xl p-6 shadow-sm border" }, [ React.createElement('h3', { key: 'title', className: "text-lg font-semibold mb-4" }, "D√≤ng xe"), React.createElement('div', { key: 'chart', className: "chart-container" }, React.createElement('canvas', { ref: carModelChartRef })) ]) ]); };
        const SettingsPanel = ({ statuses, carModels, customerSources, onSettingsUpdate, onDataReset, userName, onUserNameUpdate }) => { const [activeTab, setActiveTab] = useState('general'); const [newCarModel, setNewCarModel] = useState(''); const [newSource, setNewSource] = useState(''); const [localUserName, setLocalUserName] = useState(userName); const handleAddCarModel = () => { if (!newCarModel.trim()) return; onSettingsUpdate('carModels', [...carModels, { id: 'model_' + Date.now(), name: newCarModel }]); setNewCarModel(''); }; const handleDeleteCarModel = (id) => { if (carModels.length <= 1) return; onSettingsUpdate('carModels', carModels.filter(m => m.id !== id)); }; const handleAddSource = () => { if (!newSource.trim()) return; onSettingsUpdate('customerSources', [...customerSources, { id: 'source_' + Date.now(), name: newSource }]); setNewSource(''); }; const handleDeleteSource = (id) => { if (customerSources.length <= 1) return; onSettingsUpdate('customerSources', customerSources.filter(s => s.id !== id)); }; const handleUserNameSave = () => { onUserNameUpdate(localUserName); alert('ƒê√£ l∆∞u t√™n!'); }; const tabs = [ { id: 'general', name: 'Chung', icon: SettingsIcon }, { id: 'cars', name: 'D√≤ng xe', icon: Car }, { id: 'sources', name: 'Ngu·ªìn', icon: Users }, { id: 'data', name: 'D·ªØ li·ªáu', icon: Database } ]; return React.createElement('div', { className: "bg-white rounded-xl shadow-sm border" }, [ React.createElement('div', { key: 'tabs', className: "border-b" }, React.createElement('div', { className: "flex overflow-x-auto" }, tabs.map(tab => React.createElement('button', { key: tab.id, onClick: () => setActiveTab(tab.id), className: `flex items-center px-6 py-4 border-b-2 font-medium text-sm ${activeTab === tab.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent'}` }, [ React.createElement(tab.icon, { key: 'icon', className: "w-4 h-4 mr-2" }), tab.name ])))), React.createElement('div', { key: 'content', className: "p-6" }, (() => { switch (activeTab) { case 'general': return React.createElement('div', { className: "space-y-6" }, [ React.createElement('div', { key: 'user-info' }, [ React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "Th√¥ng tin"), React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [ React.createElement('div', {}, [ React.createElement('label', { className: "block text-sm font-medium mb-2" }, "T√™n NVKD"), React.createElement('input', { type: "text", value: localUserName, onChange: (e) => setLocalUserName(e.target.value), className: "w-full p-2 border rounded-lg" }) ]), React.createElement('div', { className: "flex items-end" }, React.createElement('button', { onClick: handleUserNameSave, className: "px-4 py-2 bg-indigo-600 text-white rounded-lg" }, "L∆∞u")) ]) ]), React.createElement('div', { key: 'app-info' }, [ React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "·ª®ng d·ª•ng"), React.createElement('div', { className: "bg-gray-50 rounded-lg p-4" }, [ React.createElement('div', { className: "grid grid-cols-2 gap-4 text-sm" }, [ React.createElement('div', {}, [ React.createElement('span', {}, "Phi√™n b·∫£n:"), React.createElement('p', { className: "font-medium" }, "2.3 (Gemini)") ]), React.createElement('div', {}, [ React.createElement('span', {}, "L∆∞u tr·ªØ:"), React.createElement('p', { className: "font-medium text-green-600" }, "Firestore") ]) ]) ]) ]) ]); case 'cars': return React.createElement('div', { className: "space-y-6" }, [ React.createElement('div', { key: 'add-car' }, [ React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "Th√™m d√≤ng xe"), React.createElement('div', { className: "flex space-x-2" }, [ React.createElement('input', { type: "text", value: newCarModel, onChange: (e) => setNewCarModel(e.target.value), className: "flex-1 p-2 border rounded-lg" }), React.createElement('button', { onClick: handleAddCarModel, className: "px-4 py-2 bg-green-600 text-white rounded-lg" }, "Th√™m") ]) ]), React.createElement('div', { key: 'car-list' }, [ React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "Danh s√°ch"), React.createElement('div', { className: "space-y-3" }, carModels.map(model => React.createElement('div', { key: model.id, className: "flex items-center justify-between p-3 border rounded-lg" }, [ React.createElement('span', { className: "font-medium" }, model.name), carModels.length > 1 && React.createElement('button', { onClick: () => handleDeleteCarModel(model.id) }, React.createElement(Trash2, { className: "w-4 h-4" })) ]))) ]) ]); case 'sources': return React.createElement('div', { className: "space-y-6" }, [ React.createElement('div', { key: 'add-source' }, [ React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "Th√™m ngu·ªìn"), React.createElement('div', { className: "flex space-x-2" }, [ React.createElement('input', { type: "text", value: newSource, onChange: (e) => setNewSource(e.target.value), className: "flex-1 p-2 border rounded-lg" }), React.createElement('button', { onClick: handleAddSource, className: "px-4 py-2 bg-green-600 text-white rounded-lg" }, "Th√™m") ]) ]), React.createElement('div', { key: 'source-list' }, [ React.createElement('h3', { className: "text-lg font-semibold mb-4" }, "Danh s√°ch"), React.createElement('div', { className: "space-y-3" }, customerSources.map(source => React.createElement('div', { key: source.id, className: "flex items-center justify-between p-3 border rounded-lg" }, [ React.createElement('span', { className: "font-medium" }, source.name), customerSources.length > 1 && React.createElement('button', { onClick: () => handleDeleteSource(source.id) }, React.createElement(Trash2, { className: "w-4 h-4" })) ]))) ]) ]); case 'data': return React.createElement('div', { className: "space-y-6" }, [ React.createElement('div', { key: 'reset', className: "border-t pt-6" }, [ React.createElement('h3', { className: "text-lg font-semibold text-red-800 mb-4" }, "X√≥a d·ªØ li·ªáu"), React.createElement('p', { className: "text-red-600 mb-4" }, "H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n Cloud Firestore."), React.createElement('button', { onClick: onDataReset, className: "px-4 py-2 bg-red-600 text-white rounded-lg" }, [ React.createElement(Trash2, { className: "w-4 h-4 mr-2" }), "X√≥a" ]) ]) ]); default: return null; } })()) ]); };
        const ToastContainer = ({ reminders, onComplete, onCustomerClick }) => { if (reminders.length === 0) return null; return React.createElement('div', { className: "fixed top-24 right-6 z-50 w-full max-w-sm space-y-3" }, reminders.map(reminder => { const isOverdue = reminder.dueDate < new Date().setHours(0, 0, 0, 0); const bgColor = isOverdue ? 'bg-red-50' : 'bg-yellow-50'; const borderColor = isOverdue ? 'border-red-400' : 'border-yellow-400'; const textColor = isOverdue ? 'text-red-800' : 'text-yellow-800'; return React.createElement('div', { key: reminder.id, className: `p-4 rounded-lg shadow-lg border ${bgColor} ${borderColor} ${textColor} animate-fade-in-right` }, [ React.createElement('div', { key: 'header', className: "flex justify-between items-start" }, [ React.createElement('div', { key: 'content', className: "flex-1" }, [ React.createElement('p', { key: 'status', className: "text-sm font-bold" }, isOverdue ? '‚ö†Ô∏è QU√Å H·∫†N' : '‚è∞ H√îM NAY'), React.createElement('p', { key: 'title', className: "mt-1 text-sm font-medium text-gray-900 cursor-pointer hover:underline", onClick: () => onCustomerClick(reminder) }, reminder.title) ]), React.createElement('button', { key: 'complete', onClick: () => onComplete(reminder.id), className: "ml-4 p-1 rounded-full text-green-600 hover:bg-green-100", title: "ƒê√°nh d·∫•u ho√†n th√†nh" }, '‚úÖ') ]) ]); }) ); };
        
        const App = () => {
            const [customers, setCustomers] = useState([]);
            const [statuses, setStatuses] = useState([]);
            const [carModels, setCarModels] = useState([]);
            const [customerSources, setCustomerSources] = useState([]);
            const [reminders, setReminders] = useState([]);
            const [salesGoals, setSalesGoals] = useState([]);
            const [userName, setUserName] = useState('');
            const [activeView, setActiveView] = useState('dashboard');
            const [isLoading, setIsLoading] = useState(true);
            const [showCustomerForm, setShowCustomerForm] = useState(false);
            const [editingCustomer, setEditingCustomer] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, customerId: null });
            const [debouncedSearchTerm, setDebouncedSearchTerm] = useState('');
            const searchTimeoutRef = useRef(null);
            const [toastReminders, setToastReminders] = useState([]);
            const [scriptModal, setScriptModal] = useState({ isOpen: false, script: '', isLoading: false });

            useEffect(() => {
                const loadData = async () => {
                    setIsLoading(true);
                    try {
                        let data = await StorageService.getAllData();
                        if (data === null) {
                            data = generateMockData();
                            await StorageService.saveAllData(data);
                        }
                        setCustomers(data.customers || []);
                        setStatuses(data.statuses || []);
                        setCarModels(data.carModels || []);
                        setCustomerSources(data.customerSources || []);
                        setReminders(data.reminders || []);
                        setSalesGoals(data.salesGoals || []);
                        setUserName(data.userName || '');
                    } catch (error) { console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error); } 
                    finally { setIsLoading(false); }
                };
                loadData();
            }, []);

            useEffect(() => {
                if (!isLoading) {
                    const dataToSave = { customers, statuses, carModels, customerSources, reminders, salesGoals, userName };
                    StorageService.saveAllData(dataToSave);
                }
            }, [customers, statuses, carModels, customerSources, reminders, salesGoals, userName]);

            useEffect(() => {
                const today = new Date().setHours(0, 0, 0, 0);
                const tomorrow = today + 24 * 60 * 60 * 1000;
                const activeReminders = reminders.filter(rem => !rem.completed && rem.dueDate < tomorrow);
                setToastReminders(activeReminders.sort((a,b) => a.dueDate - b.dueDate));
            }, [reminders]);

            const handleGenerateScript = async (customer) => {
                setScriptModal({ isOpen: true, script: '', isLoading: true });
                try {
                    const lastInteraction = customer.interactions && customer.interactions.length > 0 ?
                        [...customer.interactions].sort((a, b) => b.date - a.date)[0].notes : "ƒê√¢y l√† l·∫ßn t∆∞∆°ng t√°c ƒë·∫ßu ti√™n.";

                    const prompt = `B·∫°n l√† m·ªôt nh√¢n vi√™n b√°n h√†ng √¥ t√¥ MG chuy√™n nghi·ªáp v√† th√¢n thi·ªán. H√£y t·∫°o m·ªôt k·ªãch b·∫£n g·ªçi ƒëi·ªán tho·∫°i ng·∫Øn g·ªçn (4-5 c√¢u) ƒë·ªÉ chƒÉm s√≥c kh√°ch h√†ng.
                    
                    Th√¥ng tin kh√°ch h√†ng:
                    - T√™n: ${customer.name}
                    - ƒêang quan t√¢m xe: ${customer.carModel || 'Ch∆∞a r√µ'}
                    - Ph√¢n lo·∫°i: ${customer.tier || 'Ch∆∞a ph√¢n lo·∫°i'}
                    - Ghi ch√∫/T∆∞∆°ng t√°c cu·ªëi: ${lastInteraction}
                    
                    M·ª•c ti√™u cu·ªôc g·ªçi: 
                    1. H·ªèi thƒÉm, x√¢y d·ª±ng m·ªëi quan h·ªá.
                    2. D·ª±a v√†o th√¥ng tin ƒë√£ c√≥, g·ª£i √Ω m·ªôt b∆∞·ªõc ti·∫øp theo h·ª£p l√Ω (m·ªùi l√°i th·ª≠, th√¥ng b√°o ∆∞u ƒë√£i m·ªõi, h·ªèi v·ªÅ quy·∫øt ƒë·ªãnh...).
                    
                    Y√™u c·∫ßu: K·ªãch b·∫£n c·∫ßn t·ª± nhi√™n, kh√¥ng m√°y m√≥c. B·∫Øt ƒë·∫ßu b·∫±ng l·ªùi ch√†o "Ch√†o anh/ch·ªã ${customer.name}, em l√† [T√™n nh√¢n vi√™n] g·ªçi t·ª´ MG H·∫£i D∆∞∆°ng." v√† ƒë·ªÉ tr·ªëng t√™n nh√¢n vi√™n.`;

                    const generatedScript = await GeminiService.generateContent(prompt);
                    setScriptModal({ isOpen: true, script: generatedScript, isLoading: false });
                } catch (error) {
                    setScriptModal({ isOpen: true, script: `ƒê√£ x·∫£y ra l·ªói khi t·∫°o k·ªãch b·∫£n: ${error.message}`, isLoading: false });
                }
            };
            
            const handleSearchChange = (term) => { setSearchTerm(term); if (searchTimeoutRef.current) { clearTimeout(searchTimeoutRef.current); } searchTimeoutRef.current = setTimeout(() => { setDebouncedSearchTerm(term); }, 300); };
            const filteredCustomers = useMemo(() => { if (!debouncedSearchTerm.trim()) return customers; const term = debouncedSearchTerm.toLowerCase(); return customers.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term) || (c.email && c.email.toLowerCase().includes(term))); }, [customers, debouncedSearchTerm]);
            const handleEditCustomer = (customerData) => { setCustomers(prev => prev.map(c => c.id === editingCustomer.id ? { ...c, ...customerData } : c)); setEditingCustomer(null); };
            const handleSaveCustomer = (customerData) => { if (editingCustomer) { handleEditCustomer(customerData); } else { const newCustomer = { ...customerData, id: 'cust_' + Date.now(), interactions: [] }; const tierConfig = CUSTOMER_TIERS.find(t => t.value === newCustomer.tier); let newReminder = null; if (tierConfig && tierConfig.reminderDays > 0) { const reminderDate = new Date(); reminderDate.setDate(reminderDate.getDate() + tierConfig.reminderDays); reminderDate.setHours(9, 0, 0, 0); newReminder = { id: 'rem_' + Date.now(), customerId: newCustomer.id, title: `Li√™n h·ªá l·∫°i KH: ${newCustomer.name}`, description: `Kh√°ch h√†ng ${tierConfig.label.split(' - ')[0]}`, dueDate: reminderDate.getTime(), completed: false, priority: 'medium' }; } setCustomers(prev => [...prev, newCustomer]); if (newReminder) { setReminders(prev => [...prev, newReminder]); } } };
            const handleUpdateCustomer = (customerId, updates) => { const customerToUpdate = customers.find(c => c.id === customerId); const oldStatusId = customerToUpdate?.statusId; const newStatusId = updates.statusId; if (newStatusId === 'status3' && oldStatusId === 'status2') { if (confirm(`T·∫°o l·ªãch h·∫πn l√°i th·ª≠ cho KH "${customerToUpdate.name}" v√†o ng√†y mai?`)) { const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(10, 0, 0, 0); const testDriveReminder = { id: 'rem_' + Date.now(), customerId: customerId, title: `L√°i th·ª≠ xe cho ${customerToUpdate.name}`, dueDate: tomorrow.getTime(), completed: false, priority: 'high' }; setReminders(prev => [...prev, testDriveReminder]); } } setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, ...updates, lastContactDate: Date.now() } : c)); };
            const handleCompleteReminder = (reminderId) => { setReminders(prevReminders => prevReminders.map(rem => rem.id === reminderId ? { ...rem, completed: true } : rem)); };
            const handleDeleteCustomer = (customerId) => { setCustomers(prev => prev.filter(c => c.id !== customerId)); setDeleteConfirm({ isOpen: false, customerId: null }); };
            const openEditCustomer = (customer) => { setEditingCustomer(customer); setShowCustomerForm(true); };
            const openAddCustomer = () => { setEditingCustomer(null); setShowCustomerForm(true); };
            const closeCustomerForm = () => { setShowCustomerForm(false); setEditingCustomer(null); };
            const handleAddInteraction = (customerId, interaction) => { setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, interactions: [...(c.interactions || []), interaction], lastContactDate: Date.now() } : c)); };
            const handleDeleteInteraction = (customerId, interactionId) => { setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, interactions: (c.interactions || []).filter(i => i.id !== interactionId) } : c)); };
            const handleSettingsUpdate = (type, data) => { switch (type) { case 'carModels': setCarModels(data); break; case 'customerSources': setCustomerSources(data); break; } };
            const handleDataReset = () => { StorageService.resetData(); };
            const handleUserNameUpdate = (name) => { setUserName(name); };
            const handleReminderClick = (reminder) => { const customer = customers.find(c => c.id === reminder.customerId); if (customer) { openEditCustomer(customer); } else { alert(`Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng cho nh·∫Øc h·∫πn.`); } };
            const navItems = [ { id: 'dashboard', label: 'T·ªïng quan', icon: BarChartIcon }, { id: 'kanban', label: 'Pipeline', icon: KanbanSquare }, { id: 'list', label: 'Danh s√°ch', icon: List }, { id: 'settings', label: 'C√†i ƒë·∫∑t', icon: SettingsIcon } ];

            if (isLoading) { return React.createElement('div', { className: "min-h-screen bg-gray-50 flex items-center justify-center" }, React.createElement(LoadingSpinner)); }
            
            return React.createElement('div', { className: "min-h-screen bg-gray-50" }, [
                React.createElement('header', { key: 'header', className: "bg-white shadow-sm border-b sticky top-0 z-40" },
                    React.createElement('div', { className: "px-6 py-4" },
                        React.createElement('div', { className: "flex justify-between items-center" }, [
                            React.createElement('div', { key: 'header-left', className: "flex items-center space-x-4" }, [
                                React.createElement('div', { key: 'logo-group', className: "flex items-center space-x-3" }, [ React.createElement(Briefcase, { key: 'logo-icon', className: "w-8 h-8 text-indigo-600" }), React.createElement('div', { key: 'logo-text-group' }, [ React.createElement('h1', { key: 'app-title', className: "text-xl font-bold" }, "CRM Sales MG"), userName && React.createElement('p', { key: 'user-name-display', className: "text-sm text-gray-500" }, `NV: ${userName}`) ]) ]),
                                React.createElement('div', { key: 'search-group', className: "relative w-80" }, [ React.createElement('input', { key: 'search-input', type: "text", placeholder: "T√¨m ki·∫øm...", value: searchTerm, onChange: (e) => handleSearchChange(e.target.value), className: "w-full pl-10 pr-4 py-2 border rounded-lg" }), React.createElement('div', { key: 'search-icon-wrapper', className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement('span', null, "üîç")) ])
                            ]),
                            React.createElement('div', { key: 'header-right' }, React.createElement('button', { key: 'add-btn', onClick: openAddCustomer, className: "px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center" }, [ React.createElement(Plus, { key: 'add-customer-plus-icon', className: "w-4 h-4 mr-2" }), "Th√™m KH" ]))
                        ])
                    )
                ),
                React.createElement('nav', { key: 'navigation', className: "bg-white border-b sticky top-16 z-30" }, 
                    React.createElement('div', { className: "px-6" }, React.createElement('div', { className: "flex space-x-8" }, navItems.map(item => React.createElement('button', { key: item.id, onClick: () => setActiveView(item.id), className: `py-4 px-1 border-b-2 font-medium text-sm transition ${activeView === item.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent'}` }, [ React.createElement(item.icon, { key: item.id + '-icon', className: "w-4 h-4 mr-2 inline" }), item.label ]))))
                ),
                React.createElement('main', { key: 'main', className: "p-6" }, 
                    (() => {
                        switch (activeView) {
                            case 'dashboard': return React.createElement(Dashboard, { customers: customers, statuses: statuses, carModels: carModels, reminders: reminders });
                            case 'kanban': return React.createElement(KanbanView, { customers: filteredCustomers, statuses: statuses, onCustomerEdit: openEditCustomer, onCustomerUpdate: handleUpdateCustomer, onCustomerDelete: (id) => setDeleteConfirm({ isOpen: true, customerId: id }), onAddInteraction: handleAddInteraction, onDeleteInteraction: handleDeleteInteraction, userName: userName, onGenerateScript: handleGenerateScript });
                            case 'list': return React.createElement(ListView, { customers: filteredCustomers, statuses: statuses, onCustomerEdit: openEditCustomer, onCustomerDelete: (id) => setDeleteConfirm({ isOpen: true, customerId: id }), onGenerateScript: handleGenerateScript });
                            case 'settings': return React.createElement(SettingsPanel, { statuses: statuses, carModels: carModels, customerSources: customerSources, onSettingsUpdate: handleSettingsUpdate, onDataReset: handleDataReset, userName: userName, onUserNameUpdate: handleUserNameUpdate });
                            default: return null;
                        }
                    })()
                ),
                React.createElement(CustomerForm, { key: 'customer-form', isOpen: showCustomerForm, onClose: closeCustomerForm, onSave: handleSaveCustomer, customer: editingCustomer, statuses: statuses, carModels: carModels, customerSources: customerSources }),
                React.createElement(ConfirmationModal, { key: 'delete-confirm', isOpen: deleteConfirm.isOpen, title: "X√°c nh·∫≠n x√≥a", message: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?", onConfirm: () => handleDeleteCustomer(deleteConfirm.customerId), onCancel: () => setDeleteConfirm({ isOpen: false, customerId: null }) }),
                React.createElement(ScriptModal, { key: 'script-modal', isOpen: scriptModal.isOpen, isLoading: scriptModal.isLoading, script: scriptModal.script, onClose: () => setScriptModal({isOpen: false, script: '', isLoading: false}) }),
                React.createElement(ToastContainer, { key: 'toast-container', reminders: toastReminders, onComplete: handleCompleteReminder, onCustomerClick: handleReminderClick })
            ]);
        };

        const AppWithErrorBoundary = () => { return React.createElement(ErrorBoundary, {}, React.createElement(App)); };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(AppWithErrorBoundary));
    </script>
</body>
</html>

