<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Sales MG - Multi-User Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100">

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBtXRbpGnqTCO7lbtCk2jUQ33VHRT3N5E8",
          authDomain: "crm-mg-1819.firebaseapp.com",
          projectId: "crm-mg-1819",
          storageBucket: "crm-mg-1819.appspot.com",
          messagingSenderId: "1015548726817",
          appId: "1:1015548726817:web:71575fab36551682559d60"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        console.log("Firebase Services Initialized!");
    </script>

    <div id="root"></div>

    <script type="text/babel">
        class ErrorBoundary extends React.Component { constructor(props) { super(props); this.state = { hasError: false, error: null }; } static getDerivedStateFromError(error) { return { hasError: true, error }; } componentDidCatch(error, errorInfo) { console.error('L·ªói ·ª©ng d·ª•ng:', error, errorInfo); } render() { if (this.state.hasError) { return React.createElement('div', { className: "min-h-screen bg-gray-100 flex items-center justify-center p-4" }, React.createElement('div', { className: "bg-white p-6 rounded-lg shadow-md max-w-sm text-center" }, [ React.createElement('h2', { key: 'title', className: "text-lg font-bold text-red-600 mb-2" }, "ƒê√£ x·∫£y ra l·ªói"), React.createElement('p', { key: 'message', className: "text-gray-700" }, "·ª®ng d·ª•ng g·∫∑p s·ª± c·ªë. Vui l√≤ng t·∫£i l·∫°i trang."), React.createElement('button', { key: 'reload-button', onClick: () => window.location.reload(), className: "mt-4 px-4 py-2 bg-indigo-600 text-white rounded" }, "T·∫£i l·∫°i") ])); } return this.props.children; } }
        
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        
        const Briefcase = (props) => React.createElement('span', props, 'üíº');
        const List = (props) => React.createElement('span', props, 'üìã');
        const KanbanSquare = (props) => React.createElement('span', props, 'üìä');
        const Phone = (props) => React.createElement('span', props, 'üìû');
        const Mail = (props) => React.createElement('span', props, '‚úâÔ∏è');
        const MapPin = (props) => React.createElement('span', props, 'üìç');
        const DollarSign = (props) => React.createElement('span', props, 'üíµ');
        const X = (props) => React.createElement('span', props, '‚ùå');
        const Plus = (props) => React.createElement('span', props, '‚ûï');
        const Clock = (props) => React.createElement('span', props, '‚è∞');
        const SettingsIcon = (props) => React.createElement('span', props, '‚öôÔ∏è');
        const Trash2 = (props) => React.createElement('span', props, 'üóëÔ∏è');
        const Car = (props) => React.createElement('span', props, 'üöó');
        const Layers = (props) => React.createElement('span', props, 'üìö');
        const Save = (props) => React.createElement('span', props, 'üíæ');
        const BarChartIcon = (props) => React.createElement('span', props, 'üìä');
        const formatCurrency = (amount) => { const num = Number(amount); if (isNaN(num) || num === 0) return '0 VNƒê'; return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num); };
        const formatDate = (timestamp) => { if (!timestamp) return '---'; return new Date(timestamp).toLocaleDateString('vi-VN'); };
        const formatDateTime = (timestamp) => { if (!timestamp) return '---'; return new Date(timestamp).toLocaleString('vi-VN'); };
        
        const VIETNAM_CITIES = [ 'H√† N·ªôi', 'TP H·ªì Ch√≠ Minh', 'ƒê√† N·∫µng', 'H·∫£i Ph√≤ng', 'C·∫ßn Th∆°' ];
        const CUSTOMER_TIERS = [
            { value: 'HOT', label: 'HOT - Ti·ªÅm nƒÉng Cao', color: 'text-red-600' },
            { value: 'WARM', label: 'WARM - ƒêang ChƒÉm s√≥c', color: 'text-yellow-600' },
            { value: 'COLD', label: 'COLD - Kh√°ch h√†ng M·ªõi', color: 'text-indigo-600' },
        ];

        const LoadingSpinner = () => { return React.createElement('div', { className: "min-h-screen flex justify-center items-center" }, [ React.createElement('div', { key: "spinner-div", className: "loading-spinner" }), React.createElement('span', { key: "spinner-text", className: "ml-3 text-gray-600" }, "ƒêang t·∫£i...") ]); };
        const Modal = ({ isOpen, title, onClose, children, maxWidth = 'max-w-lg' }) => { if (!isOpen) return null; return React.createElement('div', { className: "fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex justify-center items-center p-4", onClick: (e) => { if(e.target === e.currentTarget) onClose() } }, React.createElement('div', { className: `bg-white rounded-lg shadow-xl w-full ${maxWidth} animate-fade-in` }, [ React.createElement('div', { key: 'header', className: "p-4 border-b flex justify-between items-center" }, [ React.createElement('h3', { key: 'title', className: "text-lg font-bold" }, title), React.createElement('button', { key: 'close', onClick: onClose, className: "text-gray-500 hover:text-gray-800" }, "‚úñ") ]), React.createElement('div', { key: 'content', className: "p-4 max-h-[80vh] overflow-y-auto custom-scrollbar" }, children) ])); };
        
        const LoginScreen = ({ onLogin, onGoogleLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isRegister, setIsRegister] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (!email || !password) {
                    setError('Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.');
                    return;
                }
                onLogin(email, password, isRegister).catch(err => setError(err.message));
            };

            return React.createElement('div', { className: "min-h-screen flex items-center justify-center bg-gray-100" },
                React.createElement('div', { className: "w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg" }, [
                    React.createElement('div', { key: 'header', className: 'text-center' }, [
                        React.createElement('h1', { key: 'title', className: "text-3xl font-bold text-gray-800" }, "CRM Sales MG"),
                        React.createElement('p', { key: 'subtitle', className: "mt-2 text-gray-600" }, isRegister ? "T·∫°o t√†i kho·∫£n m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu" : "ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c")
                    ]),
                    React.createElement('form', { key: 'login-form', onSubmit: handleSubmit, className: "space-y-6" }, [
                        React.createElement('input', { key: 'email', type: 'email', placeholder: 'Email', value: email, onChange: e => setEmail(e.target.value), className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" }),
                        React.createElement('input', { key: 'password', type: 'password', placeholder: 'M·∫≠t kh·∫©u', value: password, onChange: e => setPassword(e.target.value), className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" }),
                        error && React.createElement('p', { key: 'error-msg', className: "text-sm text-red-600" }, error),
                        React.createElement('button', { key: 'submit-btn', type: 'submit', className: "w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition" }, isRegister ? "ƒêƒÉng k√Ω" : "ƒêƒÉng nh·∫≠p"),
                    ]),
                    React.createElement('div', { key: 'separator', className: "relative" }, [
                        React.createElement('div', { key: 'line', className: "absolute inset-0 flex items-center" }, React.createElement('div', { className: "w-full border-t border-gray-300" })),
                        React.createElement('div', { key: 'text-wrapper', className: "relative flex justify-center text-sm" }, React.createElement('span', { className: "px-2 bg-white text-gray-500" }, "Ho·∫∑c ti·∫øp t·ª•c v·ªõi"))
                    ]),
                    React.createElement('button', { key: 'google-btn', onClick: onGoogleLogin, className: "w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition" }, [
                        React.createElement('svg', { key: 'google-icon', className: "w-5 h-5 mr-2", viewBox: "0 0 48 48" }, [
                           React.createElement('path', { key: 'g1', fill: "#EA4335", d: "M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" }),
                           React.createElement('path', { key: 'g2', fill: "#4285F4", d: "M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" }),
                           React.createElement('path', { key: 'g3', fill: "#FBBC05", d: "M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" }),
                           React.createElement('path', { key: 'g4', fill: "#34A853", d: "M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" }),
                           React.createElement('path', { key: 'g5', fill: "none", d: "M0 0h48v48H0z" })
                        ]),
                        React.createElement('span', { key: 'google-text' }, "ƒêƒÉng nh·∫≠p v·ªõi Google")
                    ]),
                    React.createElement('p', { key: 'toggle-form', className: "text-center text-sm text-gray-600" }, 
                        isRegister ? "ƒê√£ c√≥ t√†i kho·∫£n? " : "Ch∆∞a c√≥ t√†i kho·∫£n? ",
                        React.createElement('button', { onClick: () => setIsRegister(!isRegister), className: "font-medium text-indigo-600 hover:text-indigo-500" }, isRegister ? "ƒêƒÉng nh·∫≠p" : "ƒêƒÉng k√Ω ngay")
                    )
                ])
            );
        };
        
        // S·ª¨A L·ªñI: X√¢y d·ª±ng l·∫°i AppContent ƒë·∫ßy ƒë·ªß
        const AppContent = ({ user, onLogout }) => {
            const [customers, setCustomers] = useState([]);
            const [statuses, setStatuses] = useState([]);
            const [carModels, setCarModels] = useState([]);
            const [customerSources, setCustomerSources] = useState([]);
            const [reminders, setReminders] = useState([]);
            const [userName, setUserName] = useState(user.displayName || user.email);
            const [activeView, setActiveView] = useState('kanban');
            const [isLoading, setIsLoading] = useState(true);
            const [showCustomerForm, setShowCustomerForm] = useState(false);
            const [editingCustomer, setEditingCustomer] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, customerId: null });
            const [debouncedSearchTerm, setDebouncedSearchTerm] = useState('');
            const searchTimeoutRef = useRef(null);
            
            useEffect(() => {
                const unsubscribe = db.collection('data').doc('crmData')
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            setCustomers(data.customers || []);
                            setStatuses(data.statuses || []);
                            setCarModels(data.carModels || []);
                            setCustomerSources(data.customerSources || []);
                            setReminders(data.reminders || []);
                        } else {
                           console.log("No data document found! Creating initial data.");
                           const initialData = {
                               customers: [],
                               statuses: [
                                   { id: 'status1', name: '1. Kh√°ch h√†ng M·ªõi', color: 'bg-indigo-400', order: 1 },
                                   { id: 'status2', name: '2. ƒê√£ ChƒÉm s√≥c', color: 'bg-yellow-500', order: 2 },
                                   { id: 'status3', name: '3. Ti·ªÅm nƒÉng Cao', color: 'bg-red-600', order: 3 },
                                   { id: 'status4', name: '4. ƒê√£ k√Ω Hƒê', color: 'bg-green-600', order: 4 },
                                   { id: 'status5', name: '6. Lostsale', color: 'bg-black', order: 6 },
                               ],
                               carModels: [{id: 'model1', name: 'MG ZS'}, {id: 'model2', name: 'MG HS'}],
                               customerSources: [{id: 'source1', name: 'Facebook'}, {id: 'source2', name: 'Showroom'}]
                           };
                           db.collection('data').doc('crmData').set(initialData);
                        }
                        setIsLoading(false);
                    }, error => {
                        console.error("Error listening to data:", error);
                        setIsLoading(false);
                    });
                
                return () => unsubscribe();
            }, []);

            const saveData = (updatedData) => {
                 db.collection('data').doc('crmData').set(updatedData, { merge: true })
                   .catch(error => console.error("Error saving data:", error));
            };

            const handleSearchChange = (term) => {
                setSearchTerm(term);
                if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
                searchTimeoutRef.current = setTimeout(() => { setDebouncedSearchTerm(term); }, 300);
            };

            const filteredCustomers = useMemo(() => {
                if (!debouncedSearchTerm.trim()) return customers;
                const term = debouncedSearchTerm.toLowerCase();
                return customers.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term) || (c.email && c.email.toLowerCase().includes(term)));
            }, [customers, debouncedSearchTerm]);

            const handleSaveCustomer = (customerData) => {
                let updatedCustomers;
                if (editingCustomer) {
                    updatedCustomers = customers.map(c => 
                        c.id === editingCustomer.id ? { ...c, ...customerData, updatedBy: { uid: user.uid, name: user.displayName || user.email } } : c
                    );
                } else {
                    const newCustomer = { 
                        ...customerData, 
                        id: 'cust_' + Date.now(), 
                        interactions: [],
                        createdBy: { uid: user.uid, name: user.displayName || user.email }
                    };
                    updatedCustomers = [...customers, newCustomer];
                }
                saveData({ customers: updatedCustomers });
                closeCustomerForm();
            };
            
            const handleUpdateCustomer = (customerId, updates) => {
                const updatedCustomers = customers.map(c => c.id === customerId ? { ...c, ...updates, lastContactDate: Date.now() } : c);
                saveData({ customers: updatedCustomers });
            };
            
            const handleDeleteCustomer = (customerId) => {
                const updatedCustomers = customers.filter(c => c.id !== customerId);
                saveData({ customers: updatedCustomers });
                setDeleteConfirm({ isOpen: false, customerId: null });
            };
            
            const handleAddInteraction = (customerId, interaction) => {
                const updatedCustomers = customers.map(c => {
                    if (c.id === customerId) {
                        const newInteraction = { ...interaction, createdBy: { uid: user.uid, name: user.displayName || user.email } };
                        return { ...c, interactions: [...(c.interactions || []), newInteraction], lastContactDate: Date.now() };
                    }
                    return c;
                });
                saveData({ customers: updatedCustomers });
            };
            
            const handleDeleteInteraction = (customerId, interactionId) => {
                 const updatedCustomers = customers.map(c => {
                    if (c.id === customerId) {
                        return { ...c, interactions: (c.interactions || []).filter(i => i.id !== interactionId) };
                    }
                    return c;
                });
                saveData({ customers: updatedCustomers });
            };

            const openEditCustomer = (customer) => { setEditingCustomer(customer); setShowCustomerForm(true); };
            const openAddCustomer = () => { setEditingCustomer(null); setShowCustomerForm(true); };
            const closeCustomerForm = () => { setEditingCustomer(null); setShowCustomerForm(false); };
            const navItems = [ { id: 'kanban', label: 'Pipeline', icon: KanbanSquare }, { id: 'list', label: 'Danh s√°ch', icon: List } ];

            if (isLoading) {
                return React.createElement(LoadingSpinner);
            }
            
            // ƒê√¢y l√† ph·∫ßn giao di·ªán ch√≠nh b·ªã thi·∫øu
            return React.createElement('div', { className: "min-h-screen bg-gray-100" }, [
                React.createElement('header', { key: 'header', className: "bg-white shadow-sm border-b sticky top-0 z-40 p-4 flex justify-between items-center" }, [
                     React.createElement('div', { key: 'header-left', className: 'flex items-center space-x-4'}, [
                        React.createElement('h1', { key: 'title', className: 'text-xl font-bold'}, 'CRM Sales MG'),
                        React.createElement('div', { key: 'search-group', className: "relative w-64" }, [
                            React.createElement('input', { key: 'search-input', type: "text", placeholder: "T√¨m ki·∫øm...", value: searchTerm, onChange: (e) => handleSearchChange(e.target.value), className: "w-full pl-10 pr-4 py-2 border rounded-lg text-sm" }),
                            React.createElement('div', { key: 'search-icon-wrapper', className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement('span', null, "üîç"))
                        ]),
                     ]),
                    React.createElement('div', { key: 'header-right', className: 'flex items-center space-x-4' }, [
                        React.createElement('button', { key: 'add-btn', onClick: openAddCustomer, className: "px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center text-sm" }, [ React.createElement(Plus, { key: 'add-customer-plus-icon', className: "w-4 h-4 mr-2" }), "Th√™m KH" ]),
                        React.createElement('div', { key: 'user-info', className: 'flex items-center space-x-2' }, [
                            React.createElement('span', { key: 'user-name', className: 'text-sm text-gray-600'}, user.displayName || user.email),
                            React.createElement('button', { key: 'logout-btn', onClick: onLogout, className: 'px-3 py-1 border rounded-lg text-sm hover:bg-gray-100' }, "ƒêƒÉng xu·∫•t")
                        ])
                    ])
                ]),
                React.createElement('nav', { key: 'navigation', className: "bg-white border-b sticky top-[65px] z-30" }, 
                    React.createElement('div', { className: "px-6 flex space-x-8" }, 
                       navItems.map(item => React.createElement('button', { key: item.id, onClick: () => setActiveView(item.id), className: `py-4 px-1 border-b-2 font-medium text-sm flex items-center ${activeView === item.id ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}` }, [ React.createElement(item.icon, { key: item.id + '-icon', className: "w-4 h-4 mr-2" }), item.label ]))
                    )
                ),
                React.createElement('main', { key: 'main', className: "p-6" }, 
                    activeView === 'list' ? "List View Will Be Here" :
                    activeView === 'kanban' ? "Kanban View Will Be Here" :
                    null
                ),
                // Placeholder for components. They need to be defined.
            ]);
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(currentUser => {
                    setUser(currentUser);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = async (email, password, isRegister) => {
                if (isRegister) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            };

            const handleGoogleLogin = async () => {
                try {
                    await auth.signInWithPopup(googleProvider);
                } catch (error) {
                    console.error("L·ªói ƒëƒÉng nh·∫≠p Google:", error);
                    alert("Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p b·∫±ng Google. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase ho·∫∑c c·ª≠a s·ªï popup c√≥ b·ªã ch·∫∑n kh√¥ng.");
                }
            };

            const handleLogout = async () => {
                await auth.signOut();
            };

            if (isLoading) {
                return React.createElement(LoadingSpinner);
            }

            return React.createElement('div', null, 
                user ? 
                    React.createElement(AppContent, { user: user, onLogout: handleLogout }) :
                    React.createElement(LoginScreen, { onLogin: handleLogin, onGoogleLogin: handleGoogleLogin })
            );
        };

        const AppWithErrorBoundary = () => React.createElement(ErrorBoundary, {}, React.createElement(App));
        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(AppWithErrorBoundary));
    </script>
</body>
</html>

