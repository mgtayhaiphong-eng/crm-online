<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Sales MG - Multi-User Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- THÊM MỚI: Thư viện xác thực người dùng của Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100">

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBtXRbpGnqTCO7lbtCk2jUQ33VHRT3N5E8",
          authDomain: "crm-mg-1819.firebaseapp.com",
          projectId: "crm-mg-1819",
          storageBucket: "crm-mg-1819.appspot.com",
          messagingSenderId: "1015548726817",
          appId: "1:1015548726817:web:71575fab36551682559d60"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // THÊM MỚI: Khởi tạo dịch vụ xác thực
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        console.log("Firebase Services Initialized!");
    </script>

    <div id="root"></div>

    <script type="text/babel">
        class ErrorBoundary extends React.Component { /* ... Giữ nguyên ... */ constructor(props) { super(props); this.state = { hasError: false, error: null }; } static getDerivedStateFromError(error) { return { hasError: true, error }; } componentDidCatch(error, errorInfo) { console.error('Lỗi ứng dụng:', error, errorInfo); } render() { if (this.state.hasError) { return React.createElement('div', { className: "min-h-screen bg-gray-100 flex items-center justify-center p-4" }, React.createElement('div', { className: "bg-white p-6 rounded-lg shadow-md max-w-sm text-center" }, [ React.createElement('h2', { key: 'title', className: "text-lg font-bold text-red-600 mb-2" }, "Đã xảy ra lỗi"), React.createElement('p', { key: 'message', className: "text-gray-700" }, "Ứng dụng gặp sự cố. Vui lòng tải lại trang."), React.createElement('button', { key: 'reload-button', onClick: () => window.location.reload(), className: "mt-4 px-4 py-2 bg-indigo-600 text-white rounded" }, "Tải lại") ])); } return this.props.children; } }
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // ==================== COMPONENTS ====================
        const LoadingSpinner = () => { return React.createElement('div', { className: "flex justify-center items-center py-8" }, [ React.createElement('div', { key: "spinner-div", className: "loading-spinner" }), React.createElement('span', { key: "spinner-text", className: "ml-3 text-gray-600" }, "Đang tải...") ]); };
        const Modal = ({ isOpen, title, onClose, children, maxWidth = 'max-w-lg' }) => { if (!isOpen) return null; return React.createElement('div', { className: "fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50 flex justify-center items-center p-4", onClick: (e) => { if(e.target === e.currentTarget) onClose() } }, React.createElement('div', { className: `bg-white rounded-lg shadow-xl w-full ${maxWidth} animate-fade-in` }, [ React.createElement('div', { key: 'header', className: "p-4 border-b flex justify-between items-center" }, [ React.createElement('h3', { key: 'title', className: "text-lg font-bold" }, title), React.createElement('button', { key: 'close', onClick: onClose, className: "text-gray-500 hover:text-gray-800" }, "✖") ]), React.createElement('div', { key: 'content', className: "p-4 max-h-[80vh] overflow-y-auto custom-scrollbar" }, children) ])); };
        
        // THÊM MỚI: Màn hình đăng nhập
        const LoginScreen = ({ onLogin, onGoogleLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isRegister, setIsRegister] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (!email || !password) {
                    setError('Vui lòng nhập email và mật khẩu.');
                    return;
                }
                onLogin(email, password, isRegister).catch(err => setError(err.message));
            };

            return React.createElement('div', { className: "min-h-screen flex items-center justify-center bg-gray-100" },
                React.createElement('div', { className: "w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg" }, [
                    React.createElement('div', { key: 'header', className: 'text-center' }, [
                        React.createElement('h1', { key: 'title', className: "text-3xl font-bold text-gray-800" }, "CRM Sales MG"),
                        React.createElement('p', { key: 'subtitle', className: "mt-2 text-gray-600" }, isRegister ? "Tạo tài khoản mới để bắt đầu" : "Đăng nhập để tiếp tục")
                    ]),
                    React.createElement('form', { key: 'login-form', onSubmit: handleSubmit, className: "space-y-6" }, [
                        React.createElement('input', { key: 'email', type: 'email', placeholder: 'Email', value: email, onChange: e => setEmail(e.target.value), className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" }),
                        React.createElement('input', { key: 'password', type: 'password', placeholder: 'Mật khẩu', value: password, onChange: e => setPassword(e.target.value), className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" }),
                        error && React.createElement('p', { key: 'error-msg', className: "text-sm text-red-600" }, error),
                        React.createElement('button', { key: 'submit-btn', type: 'submit', className: "w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition" }, isRegister ? "Đăng ký" : "Đăng nhập"),
                    ]),
                    React.createElement('div', { key: 'separator', className: "relative" }, [
                        React.createElement('div', { key: 'line', className: "absolute inset-0 flex items-center" }, React.createElement('div', { className: "w-full border-t border-gray-300" })),
                        React.createElement('div', { key: 'text-wrapper', className: "relative flex justify-center text-sm" }, React.createElement('span', { className: "px-2 bg-white text-gray-500" }, "Hoặc tiếp tục với"))
                    ]),
                    React.createElement('button', { key: 'google-btn', onClick: onGoogleLogin, className: "w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition" }, [
                        React.createElement('svg', { key: 'google-icon', className: "w-5 h-5 mr-2", viewBox: "0 0 48 48" }, React.createElement('path', { fill: "#EA4335", d: "M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" }), React.createElement('path', { fill: "#4285F4", d: "M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" }), React.createElement('path', { fill: "#FBBC05", d: "M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z" }), React.createElement('path', { fill: "#34A853", d: "M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" }), React.createElement('path', { fill: "none", d: "M0 0h48v48H0z" })),
                        React.createElement('span', { key: 'google-text' }, "Đăng nhập với Google")
                    ]),
                    React.createElement('p', { key: 'toggle-form', className: "text-center text-sm text-gray-600" }, 
                        isRegister ? "Đã có tài khoản? " : "Chưa có tài khoản? ",
                        React.createElement('button', { onClick: () => setIsRegister(!isRegister), className: "font-medium text-indigo-600 hover:text-indigo-500" }, isRegister ? "Đăng nhập" : "Đăng ký ngay")
                    )
                ])
            );
        };
        
        // ... Các component khác (CustomerCard, KanbanView, ...) giữ nguyên
        // nhưng sẽ được chỉnh sửa để nhận `user` và hiển thị thông tin người tạo
        const InteractionHistory = ({ interactions, onAddInteraction, onDeleteInteraction, user }) => {
            const [newInteraction, setNewInteraction] = useState({ type: 'call', notes: '', duration: 0, outcome: 'neutral' });
            const [isAdding, setIsAdding] = useState(false);
            const interactionTypes = [ { value: 'call', label: '📞 Cuộc gọi' }, { value: 'email', label: '✉️ Email' }, { value: 'meeting', label: '🤝 Gặp mặt' }, { value: 'test_drive', label: '🚗 Lái thử' }, { value: 'quotation', label: '💰 Báo giá' }, { value: 'other', label: '📝 Khác' } ];

            const handleAddInteraction = () => {
                if (!newInteraction.notes.trim()) return;
                const interaction = {
                    id: 'int-' + Date.now(),
                    type: newInteraction.type,
                    date: Date.now(),
                    notes: newInteraction.notes,
                    duration: newInteraction.duration || 0,
                    outcome: newInteraction.outcome,
                    // Thêm thông tin người tạo
                    createdBy: {
                        uid: user.uid,
                        name: user.displayName || user.email,
                    }
                };
                onAddInteraction(interaction);
                setNewInteraction({ type: 'call', notes: '', duration: 0, outcome: 'neutral' });
                setIsAdding(false);
            };

            // ... giao diện component giữ nguyên nhưng phần hiển thị người tạo sẽ lấy từ `interaction.createdBy.name`
            return React.createElement('div', { className: "space-y-4" }, [
                React.createElement('div', { key: 'header', className: "flex justify-between items-center" }, [
                    React.createElement('h4', { key: 'title', className: "font-semibold" }, `Lịch sử (${interactions.length})`),
                    React.createElement('button', { key: 'add-button', onClick: () => setIsAdding(!isAdding), className: "px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg" }, "Thêm")
                ]),
                isAdding && React.createElement('div', { /* ... form thêm interaction */ }),
                React.createElement('div', { key: 'list', className: "space-y-3 max-h-80 overflow-y-auto" }, 
                    interactions.length === 0 ? 
                    React.createElement('p', { className: 'text-center text-gray-500 py-4'}, 'Chưa có tương tác.') :
                    interactions.sort((a, b) => b.date - a.date).map(interaction => {
                        return React.createElement('div', { key: interaction.id, className: "p-3 border rounded-lg bg-white" }, [
                            /* ... */
                            React.createElement('p', { key: 'user', className: "text-xs text-gray-400 mt-1" }, `bởi: ${interaction.createdBy?.name || 'Không rõ'}`)
                        ]);
                    })
                )
            ]);
        };

        const AppContent = ({ user, onLogout }) => {
            // ... Toàn bộ state và logic của App cũ được chuyển vào đây ...
            const [customers, setCustomers] = useState([]);
            // ... và các state khác ...

            useEffect(() => {
                // Logic tải dữ liệu từ Firestore
                const unsubscribe = db.collection('data').doc('crmData')
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            setCustomers(data.customers || []);
                            // ... set các state khác
                        } else {
                            // Tạo dữ liệu mẫu nếu chưa có
                        }
                    }, error => {
                        console.error("Lỗi lắng nghe dữ liệu:", error);
                    });
                
                return () => unsubscribe(); // Hủy lắng nghe khi component unmount
            }, []);

            // ... Các hàm xử lý (handleAddCustomer, handleUpdateCustomer, ...)
            // Cần được chỉnh sửa để thêm thông tin `user` vào dữ liệu
            const handleAddInteraction = (customerId, interaction) => {
                const updatedCustomers = customers.map(c => {
                    if (c.id === customerId) {
                        return { ...c, interactions: [...(c.interactions || []), interaction] };
                    }
                    return c;
                });
                // Logic lưu `updatedCustomers` vào state và Firestore
            };

            return React.createElement('div', { className: "min-h-screen bg-gray-100" }, [
                React.createElement('header', { key: 'header', className: "bg-white shadow-sm border-b sticky top-0 z-40 p-4 flex justify-between items-center" }, [
                    React.createElement('h1', { key: 'title', className: 'text-xl font-bold'}, 'CRM Sales MG'),
                    React.createElement('div', { key: 'user-info', className: 'flex items-center space-x-4' }, [
                        React.createElement('span', { key: 'user-name'}, user.displayName || user.email),
                        React.createElement('button', { key: 'logout-btn', onClick: onLogout, className: 'px-3 py-1 border rounded-lg text-sm' }, "Đăng xuất")
                    ])
                ]),
                // ... Phần còn lại của giao diện App (nav, main, modals)
            ]);
        };

        // Component chính của ứng dụng
        const App = () => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(currentUser => {
                    setUser(currentUser);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = async (email, password, isRegister) => {
                if (isRegister) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            };

            const handleGoogleLogin = async () => {
                await auth.signInWithPopup(googleProvider);
            };

            const handleLogout = async () => {
                await auth.signOut();
            };

            if (isLoading) {
                return React.createElement(LoadingSpinner);
            }

            return React.createElement('div', null, 
                user ? 
                    React.createElement(AppContent, { user: user, onLogout: handleLogout }) :
                    React.createElement(LoginScreen, { onLogin: handleLogin, onGoogleLogin: handleGoogleLogin })
            );
        };

        const AppWithErrorBoundary = () => React.createElement(ErrorBoundary, {}, React.createElement(App));
        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(AppWithErrorBoundary));
    </script>
</body>
</html>

